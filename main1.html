<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åˆ¶é€ å…¨åŸŸæŒ‡æŒ¥ä¸­å¿ƒ v7.0 (ä¸¥è°¨èåˆç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',     // Slate 900 (ä¸»èƒŒæ™¯)
                        card: '#1e293b',     // Slate 800 (å¡ç‰‡èƒŒæ™¯)
                        border: '#334155',   // Slate 700 (é€šç”¨è¾¹æ¡†)
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'Menlo', 'Consolas', 'monospace'],
                        sans: ['"Inter"', 'system-ui', '-apple-system', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', 'Microsoft YaHei', sans-serif; background-color: #0f172a; color: #94a3b8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* --- æ ¸å¿ƒï¼šCSS å˜é‡ (JS åŠ¨æ€æ³¨å…¥) --- */
        :root {
            --theme-color: #3B82F6;       /* ä¸»é¢˜è‰² */
            --theme-dim: rgba(59, 130, 246, 0.05); /* ææ·¡èƒŒæ™¯ tint */
            --theme-glow: rgba(59, 130, 246, 0.15); /* æŸ”å’Œå…‰æ™• */
        }

        /* åŠ¨æ€ç±» */
        .dynamic-text { color: var(--theme-color); transition: color 0.3s ease; }
        .dynamic-bg { background-color: var(--theme-color); transition: background-color 0.3s ease; }
        .dynamic-border { border-color: var(--theme-color); transition: border-color 0.3s ease; }
        
        /* å¯¼èˆªæ¿€æ´»æ€ï¼šæŸ”å’Œå‘å…‰ */
        .nav-item.active {
            background: linear-gradient(180deg, transparent 0%, var(--theme-dim) 100%);
            border-bottom: 2px solid var(--theme-color);
            color: #f1f5f9;
        }
        
        /* æ—¶é—´æŒ‰é’®æ¿€æ´»ï¼šå·¦ä¾§è‰²æ¡ */
        .period-btn.active {
            background: linear-gradient(90deg, var(--theme-dim), transparent);
            color: #fff;
            border-left: 3px solid var(--theme-color);
        }

        /* --- æ¨¡æ€æ¡†ï¼šä¸¥è°¨é™å™ªé£æ ¼ --- */
        #decision-modal .modal-panel {
            background-color: #1e293b; 
            border: 1px solid #334155; 
            box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.8); /* æ·±é‚ƒé˜´å½± */
        }
        
        #decision-modal .modal-header {
            background: linear-gradient(90deg, var(--theme-dim) 0%, transparent 100%);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* --- AI æŠ¥å‘Šå†…å®¹æ’ç‰ˆï¼šä½å¯¹æ¯”åº¦èåˆé£ --- */
        #modal-content {
            /* å…³é”®ï¼šç»™å†…å®¹åŒºåŠ ä¸€å±‚ææ·¡çš„ä¸»é¢˜è‰²è’™ç‰ˆï¼Œé™ä½é»‘åº•çš„ç”Ÿç¡¬æ„Ÿ */
            background-image: linear-gradient(180deg, var(--theme-dim) 0%, rgba(15, 23, 42, 0.6) 100%);
            padding: 2.5rem;
        }

        .ai-report-wrapper {
            /* æ¨¡æ‹Ÿçº¸å¼ /å±å¹•çš„å®¹å™¨æ„Ÿ */
            border-left: 2px solid var(--theme-color); /* å·¦ä¾§è£…è®¢çº¿ */
            padding-left: 1.5rem;
        }

        .ai-content {
            font-size: 0.95rem;
            line-height: 1.8; /* å¢åŠ è¡Œé«˜ï¼Œæå‡ä¸¥è°¨æ„Ÿ */
            color: #94a3b8; /* Slate 400: é™ä½æ­£æ–‡å¯¹æ¯”åº¦ï¼Œä¸åˆºçœ¼ */
        }
        
        .ai-content h3 { 
            color: var(--theme-color); 
            font-weight: 600; 
            font-size: 1.1rem;
            margin-top: 2rem; 
            margin-bottom: 1rem; 
            display: flex;
            align-items: center;
            letter-spacing: 0.05em;
        }
        
        /* æ ‡é¢˜è£…é¥°çº¿ */
        .ai-content h3::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--theme-color), transparent);
            margin-left: 1rem;
            opacity: 0.3;
        }

        .ai-content ul { padding-left: 0; list-style: none; margin-bottom: 1.5rem; }
        
        .ai-content li { 
            margin-bottom: 0.8rem; 
            position: relative;
            padding-left: 1.2rem;
        }
        
        /* åˆ—è¡¨é¡¹ç¬¦å·ï¼šæ–¹å—ç‚¹ï¼Œæ›´å·¥ä¸šåŒ– */
        .ai-content li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.7em;
            width: 4px;
            height: 4px;
            background-color: var(--theme-color);
            opacity: 0.8;
        }

        .ai-content strong { 
            color: #e2e8f0; /* Slate 200: é‡ç‚¹æ–‡å­—å¾®äº®ï¼Œä¸çº¯ç™½ */
            font-weight: 600;
            border-bottom: 1px dotted var(--theme-color); /* è™šçº¿å¼ºè°ƒ */
            padding-bottom: 1px;
        }

        .ai-content .data-tag {
            font-family: 'JetBrains Mono', monospace;
            background: var(--theme-dim);
            border: 1px solid var(--theme-color);
            color: var(--theme-color);
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.85em;
            margin: 0 4px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 2px solid rgba(255,255,255,0.05);
            border-top: 2px solid var(--theme-color);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s cubic-bezier(0.55, 0.085, 0.68, 0.53) infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm" onkeydown="handleGlobalKeys(event)">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="h-14 bg-card border-b border-border flex items-center justify-between px-6 shrink-0 z-30 shadow-md">
        <div class="flex items-center gap-8">
            <div class="text-lg font-bold tracking-wider text-white flex items-center gap-2 select-none">
                <i class="fa-solid fa-layer-group dynamic-text text-xl"></i> 
                <span class="font-sans">SMCC</span>
                <span class="text-[10px] bg-white/5 text-gray-400 px-1.5 py-0.5 rounded border border-white/5 font-mono">v7.0</span>
            </div>
            
            <nav class="flex h-14 space-x-2">
                <button onclick="switchTab('ot')" id="nav-ot" class="nav-item h-full px-4 flex items-center gap-2 transition-all border-b-2 border-transparent text-gray-400 hover:text-white">
                    <i class="fa-solid fa-server text-xs"></i> <span>OT æ•°æ®</span>
                </button>
                <button onclick="switchTab('workflow')" id="nav-workflow" class="nav-item h-full px-4 flex items-center gap-2 transition-all border-b-2 border-transparent text-gray-400 hover:text-white">
                    <i class="fa-solid fa-list-check text-xs"></i> <span>MES æ‰§è¡Œ</span>
                </button>
                <button onclick="switchTab('info')" id="nav-info" class="nav-item h-full px-4 flex items-center gap-2 transition-all border-b-2 border-transparent text-gray-400 hover:text-white">
                    <i class="fa-solid fa-file-waveform text-xs"></i> <span>PLM å·¥è‰º</span>
                </button>
                <button onclick="switchTab('finance')" id="nav-finance" class="nav-item h-full px-4 flex items-center gap-2 transition-all border-b-2 border-transparent text-gray-400 hover:text-white">
                    <i class="fa-solid fa-sack-dollar text-xs"></i> <span>FIN èµ„é‡‘</span>
                </button>
            </nav>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="generateGlobalBriefing()" class="dynamic-bg hover:opacity-90 text-white px-4 py-1.5 rounded-sm shadow-lg flex items-center gap-2 transition-all active:scale-95 text-xs font-semibold tracking-wide">
                <i class="fa-solid fa-file-contract"></i> 
                <span>æŒ‡æŒ¥ç®€æŠ¥</span>
            </button>
            
            <div class="h-6 w-px bg-gray-700/50 mx-2"></div>
            
            <!-- é‚®ä»¶å›¾æ ‡ -->
            <a href="mailto:junshan@icloud.com" class="w-9 h-9 rounded hover:bg-white/5 flex items-center justify-center text-gray-400 hover:text-white transition-colors" title="è”ç³»ç®¡ç†å‘˜: junshan@icloud.com">
                <i class="fa-solid fa-envelope"></i>
            </a>

            <!-- è®¾ç½® -->
            <button onclick="openSettings()" class="w-9 h-9 rounded hover:bg-white/5 flex items-center justify-center text-gray-400 hover:text-white transition-colors" title="ç³»ç»Ÿè®¾ç½®">
                <i class="fa-solid fa-gear"></i>
            </button>
            
            <!-- AI åŠ©æ‰‹ -->
            <button onclick="toggleChat()" class="w-9 h-9 rounded hover:bg-white/5 flex items-center justify-center text-gray-400 hover:text-white relative transition-colors" title="æˆ˜æƒ…åŠ©æ‰‹ (Ctrl+/)">
                <i class="fa-solid fa-comment-dots dynamic-text text-lg"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- ä¾§è¾¹æ  -->
        <aside class="w-60 bg-card border-r border-border flex flex-col shrink-0 z-20">
            <div class="p-5 border-b border-border">
                <div class="text-[10px] font-bold text-gray-500 uppercase mb-3 tracking-widest pl-1">æ—¶é—´è§†çª—</div>
                <div class="space-y-1">
                    <button onclick="switchPeriod('daily')" id="btn-daily" class="period-btn w-full flex items-center justify-between px-4 py-2.5 rounded-sm text-gray-400 hover:bg-white/5 transition-all group">
                        <span class="flex items-center gap-3"><i class="fa-solid fa-clock w-4 text-center text-gray-500 group-hover:text-white transition-colors"></i> æ—¥æŠ¥</span>
                        <span class="text-[10px] bg-black/30 px-1.5 rounded text-gray-500 font-mono">D</span>
                    </button>
                    <button onclick="switchPeriod('weekly')" id="btn-weekly" class="period-btn w-full flex items-center justify-between px-4 py-2.5 rounded-sm text-gray-400 hover:bg-white/5 transition-all group">
                        <span class="flex items-center gap-3"><i class="fa-solid fa-calendar-week w-4 text-center text-gray-500 group-hover:text-white transition-colors"></i> å‘¨æŠ¥</span>
                        <span class="text-[10px] bg-black/30 px-1.5 rounded text-gray-500 font-mono">W</span>
                    </button>
                    <button onclick="switchPeriod('monthly')" id="btn-monthly" class="period-btn w-full flex items-center justify-between px-4 py-2.5 rounded-sm text-gray-400 hover:bg-white/5 transition-all group">
                        <span class="flex items-center gap-3"><i class="fa-solid fa-calendar-days w-4 text-center text-gray-500 group-hover:text-white transition-colors"></i> æœˆæŠ¥</span>
                        <span class="text-[10px] bg-black/30 px-1.5 rounded text-gray-500 font-mono">M</span>
                    </button>
                </div>
            </div>

            <div class="flex-1 p-4 overflow-y-auto" id="drill-down-menu">
                <!-- åŠ¨æ€é’»å–èœå• -->
            </div>
            
            <div class="p-4 bg-black/20 text-[10px] text-gray-600 border-t border-border flex justify-between items-center">
                <span class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-gray-600 transition-colors" id="api-dot"></div> API Status</span>
                <span id="api-status-text" class="font-mono">Unconfigured</span>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="flex-1 bg-dark relative flex flex-col overflow-hidden p-6" id="main-content">
            <!-- åŠ¨æ€æ³¨å…¥å†…å®¹ -->
        </main>

        <!-- æ‚¬æµ®ç»„ä»¶ -->
        
        <!-- API è®¾ç½®å¼¹çª— -->
        <div id="settings-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-card w-full max-w-md rounded border border-border shadow-2xl p-8">
                <h3 class="text-lg font-bold text-white mb-6 border-b border-border pb-4 flex items-center gap-2">
                    <i class="fa-solid fa-key text-gray-500"></i> ç³»ç»Ÿè®¾ç½®
                </h3>
                <div class="mb-6">
                    <label class="block text-gray-400 text-xs font-bold mb-2 uppercase tracking-wide">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full bg-dark border border-border rounded px-4 py-3 text-white focus:outline-none dynamic-border placeholder-gray-700 text-sm font-mono transition-colors" placeholder="sk-...">
                    <p class="text-[10px] text-gray-600 mt-2">Key ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œç›´æ¥è¿æ¥ Google APIã€‚</p>
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="closeSettings()" class="px-5 py-2 rounded border border-border text-gray-300 hover:bg-white/5 text-xs font-medium transition-colors">å–æ¶ˆ</button>
                    <button onclick="saveApiKey()" class="dynamic-bg text-white px-5 py-2 rounded hover:opacity-90 text-xs font-bold shadow-lg transition-all">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>

        <!-- AI åŠ©æ‰‹èŠå¤©çª— -->
        <div id="chat-widget" class="fixed bottom-6 right-6 w-80 h-[500px] bg-card border border-border rounded shadow-2xl flex flex-col z-40 transform translate-y-[120%] transition-transform duration-300 overflow-hidden">
            <div class="px-4 py-3 border-b border-border flex justify-between items-center shrink-0" style="background: linear-gradient(90deg, var(--theme-dim), transparent);">
                <div class="font-bold text-gray-200 flex items-center gap-2 text-sm"><i class="fa-solid fa-robot dynamic-text"></i> æˆ˜æƒ…åŠ©æ‰‹</div>
                <button onclick="toggleChat()" class="text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-dark/80">
                <!-- æ¶ˆæ¯ -->
            </div>
            <div class="p-3 border-t border-border bg-card">
                <div class="flex gap-2 relative">
                    <input type="text" id="chat-input" placeholder="è¾“å…¥æŒ‡ä»¤..." class="w-full bg-dark border border-border rounded px-3 py-2.5 text-white focus:outline-none dynamic-border pr-9 text-xs shadow-inner" onkeydown="if(event.key==='Enter') sendChatMessage()">
                    <button onclick="sendChatMessage()" class="absolute right-2 top-2.5 dynamic-text hover:text-white transition-colors"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <!-- å†³ç­–æ¨æ¼”/ç®€æŠ¥æ¨¡æ€æ¡† -->
        <div id="decision-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-4 backdrop-blur-md">
            <div class="modal-panel bg-card w-full max-w-4xl max-h-[90vh] rounded flex flex-col overflow-hidden animate-fade-in-up">
                <!-- æ ‡é¢˜æ  -->
                <div class="modal-header px-8 py-5 flex justify-between items-center shrink-0">
                    <h2 class="text-xl font-bold text-white flex items-center gap-3" id="modal-title">
                        <i class="fa-solid fa-brain dynamic-text"></i> 
                        <span>AI å†³ç­–æ¨æ¼”</span>
                    </h2>
                    <div class="flex gap-4 items-center">
                        <span class="text-[10px] text-gray-500 font-mono border border-gray-700 px-2 py-0.5 rounded bg-black/20">CONFIDENTIAL</span>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-white transition-colors"><i class="fa-solid fa-times text-xl"></i></button>
                    </div>
                </div>
                
                <!-- å†…å®¹åŒº -->
                <div class="overflow-y-auto bg-dark" id="modal-content">
                    <!-- AI å†…å®¹æ³¨å…¥åŒº -->
                </div>
                
                <!-- åº•éƒ¨ -->
                <div class="px-8 py-3 border-t border-border bg-card flex justify-between items-center text-[10px] text-gray-500">
                    <span class="flex items-center gap-2"><i class="fa-solid fa-microchip"></i> Powered by Gemini 2.5 Flash</span>
                    <button onclick="closeModal()" class="px-4 py-1.5 rounded border border-border text-gray-400 hover:text-white hover:bg-white/5 transition-colors">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. å…¨å±€é…ç½® & è‰²å½©æ˜ å°„ ---
        let apiKey = localStorage.getItem('smcc_gemini_key') || "";
        
        const themeMap = {
            ot: { 
                hex: '#3B82F6', // Blue-500
                dim: 'rgba(59, 130, 246, 0.05)',
                glow: 'rgba(59, 130, 246, 0.15)'
            },
            workflow: { 
                hex: '#10B981', // Emerald-500
                dim: 'rgba(16, 185, 129, 0.05)',
                glow: 'rgba(16, 185, 129, 0.15)'
            },
            info: { 
                hex: '#A855F7', // Purple-500
                dim: 'rgba(168, 85, 247, 0.05)',
                glow: 'rgba(168, 85, 247, 0.15)'
            },
            finance: { 
                hex: '#F59E0B', // Amber-500
                dim: 'rgba(245, 158, 11, 0.05)',
                glow: 'rgba(245, 158, 11, 0.15)'
            }
        };
        const state = { tab: 'ot', period: 'daily' };

        // --- 2. æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨ ---
        const genData = (c, min, max) => Array.from({length: c}, () => Math.floor(Math.random()*(max-min+1)+min));
        const genLabels24h = () => Array.from({length:24},(_,i)=>`${i}:00`);
        
        const reportData = {
            ot: {
                drill: [{name:'OEE æŸå¤±', icon:'fa-chart-pie', key:'O'}, {name:'MTBF åˆ†æ', icon:'fa-heart-pulse', key:'M'}, {name:'èƒ½è€—å®¡è®¡', icon:'fa-bolt', key:'E'}],
                content: {
                    daily: {
                        kpi: [{l:'ç»¼åˆæ•ˆç‡ OEE',v:'78.4%',t:'-2.1%',s:'text-red-400'},{l:'å¹³å‡æ•…éšœé—´éš”',v:'4.2h',t:'-0.5h',s:'text-yellow-400'},{l:'èƒ½è€—å•è€—',v:'1.2kW',t:'-5%',s:'text-green-400'}],
                        events: [{t:'09:15',m:'2å·æœºä¸»è½´æ¸©åº¦è¿‡é«˜ (75Â°C)',type:'alert'},{t:'10:30',m:'ç©ºå‹æœº#3 è´Ÿè½½æ³¢åŠ¨å¼‚å¸¸',type:'warn'}],
                        chartTitle: '24å°æ—¶ OEE è¶‹åŠ¿ç›‘æ§', chartType: 'line',
                        chartData: {labels:genLabels24h(), data:genData(24,60,95)},
                        context: "2å·æœºä¸Šåˆçš„ä¸»è½´è¿‡çƒ­æ•…éšœæ‹‰ä½äº†æ•´ä½“OEEï¼Œå»ºè®®æ£€æŸ¥æ¶¦æ»‘æ²¹è·¯ã€‚"
                    }
                }
            },
            workflow: {
                drill: [{name:'æ’äº§è¾¾æˆ',icon:'fa-tasks',key:'S'},{name:'WIP åˆ†æ',icon:'fa-boxes-stacked',key:'W'},{name:'äººæ•ˆç›‘æ§',icon:'fa-user-clock',key:'P'}],
                content: {
                    daily: {
                        kpi: [{l:'æ’äº§è¾¾æˆç‡',v:'94%',t:'-4%',s:'text-yellow-400'},{l:'WIP ç§¯å‹',v:'12æ‰¹',t:'+2',s:'text-red-400'},{l:'äººå‡äº§å‡º',v:'420pc',t:'+10',s:'text-green-400'}],
                        events: [{t:'08:00',m:'æ—©ç­ç¼ºå‹¤ç‡ 5% (å¯åŠ¨æ›¿è¡¥)',type:'warn'},{t:'11:00',m:'å·¥åº3 ç¼ºæ–™æŠ¥è­¦',type:'alert'}],
                        chartTitle: 'å„æ—¶æ®µäº§å‡ºé‡ç›‘æ§', chartType: 'bar',
                        chartData: {labels:genLabels24h(), data:genData(24,200,500)},
                        context: "ç¼ºå‹¤å åŠ ç¼ºæ–™å¯¼è‡´å·¥åº3ç“¶é¢ˆï¼ŒWIPç§¯å‹ä¸¥é‡ã€‚"
                    }
                }
            },
            info: {
                drill: [{name:'BOM ç®¡ç†',icon:'fa-list-check',key:'B'},{name:'ECN å˜æ›´',icon:'fa-code-branch',key:'C'},{name:'å·¥è‰ºé…æ–¹',icon:'fa-flask',key:'R'}],
                content: {
                    daily: {
                        kpi: [{l:'BOM ç”¨é‡å·®',v:'1.2%',t:'+0.5%',s:'text-red-400'},{l:'é»„é‡‘æ‰¹æ¬¡',v:'0.9',t:'0',s:'text-green-400'},{l:'ECN å¾…åŠ',v:'2',t:'+1',s:'text-yellow-400'}],
                        events: [{t:'09:00',m:'é…æ–¹ V2.1 æ ¡éªŒå¤±è´¥',type:'alert'}],
                        chartTitle: 'å…³é”®å·¥è‰ºå‚æ•°æ³¢åŠ¨', chartType: 'line',
                        chartData: {labels:genLabels24h(), data:genData(24,180,220)},
                        context: "æŠ•æ–™åå·®å¯¼è‡´BOMæˆæœ¬å·®å¼‚ï¼Œéœ€æ ¡å‡†ç§°é‡æ¨¡å—ã€‚"
                    }
                }
            },
            finance: {
                drill: [{name:'æˆæœ¬æ–¹å·®',icon:'fa-money-bill-trend-up',key:'C'},{name:'ç°é‡‘å‘¨è½¬',icon:'fa-rotate',key:'R'},{name:'æ¯›åˆ©åˆ†æ',icon:'fa-hand-holding-dollar',key:'P'}],
                content: {
                    daily: {
                        kpi: [{l:'æ—¥æˆæœ¬æ–¹å·®',v:'-Â¥5k',t:'æ¶åŒ–',s:'text-red-400'},{l:'ææ–™é‡å·®',v:'+3%',t:'',s:'text-red-400'},{l:'äººå·¥æ•ˆç‡',v:'-1%',t:'',s:'text-green-400'}],
                        events: [{t:'16:00',m:'Batch #405 è´µé‡‘å±è¶…è€—',type:'alert'}],
                        chartTitle: 'åˆ¶é€ æˆæœ¬æ–¹å·®åˆ†è§£', chartType: 'bar',
                        chartData: {labels:['é‡å·®','ä»·å·®','æ•ˆç‡','è´¹ç‡'], data:[-4000,500,1000,0]},
                        context: "ææ–™é‡å·®æ˜¯ä¸»è¦äºæŸæºï¼ŒBatch #405 å·¥è‰ºæµªè´¹ä¸¥é‡ã€‚"
                    }
                }
            }
        };

        // --- 3. æ ¸å¿ƒé€»è¾‘ ---
        function init() {
            updateApiStatus();
            render();
        }

        function render() {
            const theme = themeMap[state.tab];
            const tabData = reportData[state.tab];
            const data = tabData.content[state.period] || tabData.content.daily;
            
            // æ³¨å…¥ CSS å˜é‡
            const root = document.documentElement;
            root.style.setProperty('--theme-color', theme.hex);
            root.style.setProperty('--theme-dim', theme.dim);
            root.style.setProperty('--theme-glow', theme.glow);

            // UI çŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${state.tab}`).classList.add('active');

            document.querySelectorAll('.period-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-${state.period}`).classList.add('active');

            // é’»å–èœå•
            const drills = tabData.drill.map(d => `
                <button class="w-full text-left px-4 py-3 rounded-sm text-gray-400 hover:bg-white/5 transition-colors flex justify-between items-center group">
                    <span class="flex items-center gap-3 text-sm font-medium"><i class="fa-solid ${d.icon} w-5 text-center dynamic-text opacity-70 group-hover:opacity-100 transition-opacity"></i> ${d.name}</span>
                    <span class="text-[10px] border border-gray-700 px-1.5 py-0.5 rounded opacity-50 font-mono group-hover:border-gray-500 transition-colors">${d.key}</span>
                </button>
            `).join('');
            document.getElementById('drill-down-menu').innerHTML = `<div class="text-[10px] font-bold text-gray-500 uppercase mt-4 mb-2 px-4 tracking-widest pl-1">æ·±åº¦é’»å–</div><div class="space-y-1">${drills}</div>`;

            // ä¸»ç½‘æ ¼
            const main = document.getElementById('main-content');
            const kpiHTML = data.kpi.map(k => `
                <div class="bg-card rounded border border-border p-4 shadow-sm hover:border-gray-600 transition-colors relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-0.5 h-full dynamic-bg opacity-50"></div>
                    <div class="text-[11px] text-gray-400 uppercase tracking-wide flex justify-between mb-2">
                        ${k.l} <i class="fa-solid fa-ellipsis text-gray-700 hover:text-white cursor-pointer"></i>
                    </div>
                    <div class="flex items-baseline gap-3">
                        <span class="text-2xl font-bold text-white font-mono tracking-tight">${k.v}</span>
                        ${k.t ? `<span class="text-xs font-bold ${k.s} bg-black/20 px-1.5 rounded">${k.t.includes('-')||k.t.includes('æ¶åŒ–')?'â–¼':'â–²'} ${k.t}</span>` : ''}
                    </div>
                </div>
            `).join('');

            main.innerHTML = `
                <div class="flex flex-col h-full gap-6">
                    <!-- KPI -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 shrink-0">
                        ${kpiHTML}
                    </div>

                    <!-- Middle -->
                    <div class="flex-1 grid grid-cols-12 gap-6 min-h-0">
                        <!-- Chart -->
                        <div class="col-span-12 lg:col-span-9 bg-card rounded border border-border shadow-md relative flex flex-col">
                            <div class="p-4 border-b border-border flex justify-between items-center shrink-0 bg-white/[0.01]">
                                <h3 class="text-gray-200 font-bold flex items-center gap-2 text-sm">
                                    <i class="fa-solid fa-chart-line dynamic-text"></i> ${data.chartTitle}
                                </h3>
                                <button onclick="triggerAIDecision()" class="dynamic-bg hover:opacity-90 text-white px-3 py-1.5 rounded-sm text-xs font-bold flex items-center gap-2 shadow-sm transition-all active:scale-95">
                                    <i class="fa-solid fa-brain"></i> å†³ç­–æ¨æ¼”
                                </button>
                            </div>
                            <div class="flex-1 relative w-full overflow-hidden p-2">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>

                        <!-- Ticker -->
                        <div class="col-span-12 lg:col-span-3 bg-card rounded border border-border flex flex-col overflow-hidden">
                            <div class="p-3 border-b border-border bg-black/20 flex justify-between items-center">
                                <span class="text-xs font-bold text-gray-300 flex items-center gap-2"><i class="fa-solid fa-bell dynamic-text"></i> äº‹ä»¶æµ</span>
                                <span class="text-[10px] text-gray-500 font-mono">${data.events.length} MSG</span>
                            </div>
                            <div class="flex-1 overflow-y-auto">
                                <div class="divide-y divide-border">
                                    ${data.events.map(e => `
                                        <div class="p-3 hover:bg-white/5 transition-colors border-l-2 ${e.type==='alert'?'border-red-500':(e.type==='warn'?'border-yellow-500':'border-transparent')}">
                                            <div class="flex justify-between mb-1">
                                                <span class="text-[10px] font-mono text-gray-500">${e.t}</span>
                                                ${e.type==='alert' ? '<i class="fa-solid fa-triangle-exclamation text-red-500 text-xs"></i>' : (e.type==='warn'?'<i class="fa-solid fa-circle-exclamation text-yellow-500 text-xs"></i>':'<i class="fa-solid fa-info-circle text-blue-500 text-xs"></i>')}
                                            </div>
                                            <div class="text-xs text-gray-300 leading-snug">${e.m}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            renderChart(data, theme);
        }

        // --- 4. å›¾è¡¨ ---
        let chartInstance = null;
        function renderChart(data, theme) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, theme.hex + '66');
            gradient.addColorStop(1, theme.hex + '00');

            const config = {
                type: data.chartType || 'line',
                data: {
                    labels: data.chartData.labels,
                    datasets: [{
                        label: 'æ•°å€¼',
                        data: data.chartData.data,
                        borderColor: theme.hex,
                        backgroundColor: data.chartType === 'line' ? gradient : theme.hex,
                        borderWidth: 2,
                        pointBackgroundColor: '#1e293b',
                        pointBorderColor: theme.hex,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#334155', drawBorder: false }, ticks: { color: '#64748b', font: {family:'monospace'} } },
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: {family:'monospace'}, maxTicksLimit: 12 } }
                    }
                }
            };
            if(data.chartType === 'doughnut' || data.chartType === 'pie') {
                config.data.datasets[0].backgroundColor = [theme.hex, '#475569', '#1e293b'];
                config.data.datasets[0].borderColor = '#1e293b';
                delete config.options.scales;
            }
            chartInstance = new Chart(ctx, config);
        }

        // --- 5. Gemini AI (Error Handling) ---
        async function callGemini(prompt) {
            if (!apiKey) return new Promise(resolve => setTimeout(() => resolve(`
                <div class="ai-report-wrapper">
                    <h3><i class="fa-solid fa-triangle-exclamation"></i> æ¼”ç¤ºæ¨¡å¼</h3>
                    <ul>
                        <li>å½“å‰æœªé…ç½® API Keyï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®ã€‚</li>
                        <li><strong>æ¨¡æ‹Ÿç»“è®ºï¼š</strong> æ£€æµ‹åˆ° KPI å¼‚å¸¸æ³¢åŠ¨ï¼Œå»ºè®®æ ¸æŸ¥è®¾å¤‡å‚æ•°ã€‚</li>
                    </ul>
                </div>
            `), 800));
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || response.status);
                
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "<h3>âš ï¸ å“åº”ä¸ºç©º</h3>";
            } catch (e) { 
                return `<div class="ai-report-wrapper"><h3>ğŸš« API è°ƒç”¨å¤±è´¥</h3><p>${e.message}</p></div>`; 
            }
        }

        async function triggerAIDecision() {
            const modal = document.getElementById('decision-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            content.innerHTML = `<div class="flex flex-col items-center justify-center py-20 gap-4"><div class="loader"></div><div class="text-gray-500 font-mono text-xs dynamic-text">NEURAL ENGINE ANALYZING...</div></div>`;
            
            const data = reportData[state.tab].content[state.period] || reportData[state.tab].content.daily;
            const prompt = `
                è§’è‰²ï¼šå·¥ä¸šæŒ‡æŒ¥ä¸­å¿ƒ AI å¼•æ“ã€‚
                åœºæ™¯ï¼š${state.tab.toUpperCase()}æ¿å—-${state.period.toUpperCase()}ã€‚
                KPIï¼š${JSON.stringify(data.kpi)}ã€‚
                äº‹ä»¶ï¼š${JSON.stringify(data.events)}ã€‚
                èƒŒæ™¯ï¼š${data.context}ã€‚
                è¦æ±‚ï¼šè¾“å‡º HTML (æ— markdown)ï¼Œç»“æ„ï¼š
                <div class="ai-report-wrapper">
                    <h3><i class="fa-solid fa-radar"></i> æ€åŠ¿æ„ŸçŸ¥</h3>
                    ...ç®€è¿°æ ¸å¿ƒé—®é¢˜...
                    <h3><i class="fa-solid fa-microscope"></i> æ ¹å› æŒ–æ˜</h3>
                    ...åˆ—è¡¨åˆ†æ...
                    <h3><i class="fa-solid fa-bolt"></i> è¡ŒåŠ¨æŒ‡ä»¤</h3>
                    ...å…·ä½“å»ºè®® (ç”¨<strong></strong>åŠ ç²—å…³é”®å‚æ•°)...
                </div>
            `;
            const html = await callGemini(prompt);
            content.innerHTML = html;
        }

        async function generateGlobalBriefing() {
            const modal = document.getElementById('decision-modal');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-title').innerHTML = '<i class="fa-solid fa-file-contract dynamic-text"></i> å…¨åŸŸæŒ‡æŒ¥ç®€æŠ¥';
            modal.classList.remove('hidden');
            content.innerHTML = `<div class="flex flex-col items-center justify-center py-20 gap-4"><div class="loader"></div><div class="text-gray-500 font-mono text-xs dynamic-text">SCANNING GLOBAL STREAMS...</div></div>`;
            
            let context = "";
            ['ot','workflow','info','finance'].forEach(t => {
                const d = reportData[t].content.daily;
                context += `[${t}] KPI:${JSON.stringify(d.kpi)}\n`;
            });

            const prompt = `
                è§’è‰²ï¼šå·¥å‚æ€»å‚è°‹ã€‚
                ä»»åŠ¡ï¼šç”Ÿæˆå…¨åŸŸäº¤æ¥ç­ç®€æŠ¥ï¼ˆHTMLï¼‰ã€‚
                æ•°æ®ï¼š${context}
                ç»“æ„ï¼š
                <div class="ai-report-wrapper">
                    <h3><i class="fa-solid fa-globe"></i> è¿è¥ç»¼è¿°</h3>
                    ...æ•´ä½“è¯„ä»·...
                    <h3><i class="fa-solid fa-triangle-exclamation"></i> é£é™©é¢„è­¦</h3>
                    ...2ä¸ªçº¢ç¯é¡¹...
                    <h3><i class="fa-solid fa-list-check"></i> é‡ç‚¹æŒ‡ä»¤</h3>
                    ...3æ¡æŒ‡ä»¤...
                </div>
            `;
            const html = await callGemini(prompt);
            content.innerHTML = html;
        }

        // --- 6. äº¤äº’ ---
        function switchTab(t) { state.tab = t; render(); }
        function switchPeriod(p) { state.period = p; render(); }
        
        function openSettings() { document.getElementById('api-key-input').value = apiKey; document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveApiKey() { 
            const val = document.getElementById('api-key-input').value.trim();
            if(val) { apiKey = val; localStorage.setItem('smcc_gemini_key', apiKey); updateApiStatus(); closeSettings(); }
        }
        function updateApiStatus() {
            const el = document.getElementById('api-status-text');
            const dot = document.getElementById('api-dot');
            if(apiKey) { el.innerText = 'Online'; el.className = 'font-mono text-green-500'; dot.classList.replace('bg-gray-600', 'bg-green-500'); }
            else { el.innerText = 'Offline'; el.className = 'font-mono text-gray-500'; dot.classList.replace('bg-green-500', 'bg-gray-600'); }
        }

        function toggleChat() { 
            const el = document.getElementById('chat-widget');
            el.style.transform = el.style.transform === 'translateY(0%)' ? 'translateY(120%)' : 'translateY(0%)';
        }
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const msgs = document.getElementById('chat-messages');
            const val = input.value.trim();
            if(!val) return;
            msgs.innerHTML += `<div class="bg-white/5 p-2.5 rounded text-gray-200 text-xs self-end text-right border border-white/5 ml-8 mb-3">${val}</div>`;
            input.value = ''; msgs.scrollTop = msgs.scrollHeight;
            const loadingId = Date.now();
            msgs.innerHTML += `<div id="${loadingId}" class="bg-card p-2.5 rounded text-gray-400 self-start mr-8 text-xs flex items-center gap-2 mb-3 border border-border"><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div> å¤„ç†ä¸­...</div>`;
            const reply = await callGemini(val);
            document.getElementById(loadingId).innerHTML = reply;
            msgs.scrollTop = msgs.scrollHeight;
        }
        function closeModal() { document.getElementById('decision-modal').classList.add('hidden'); }
        function handleGlobalKeys(e) {
            if(e.altKey && e.key>='1' && e.key<='4') switchTab(['ot','workflow','info','finance'][parseInt(e.key)-1]);
            if(e.key==='Escape') { closeModal(); closeSettings(); document.getElementById('chat-widget').style.transform='translateY(120%)'; }
        }

        init();
    </script>
</body>
</html>