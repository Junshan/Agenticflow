<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åˆ¶é€ å…¨åŸŸæŒ‡æŒ¥ä¸­å¿ƒ v4.0 (ä¸¥è°¨å†³ç­–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',     // Slate 900 (èƒŒæ™¯)
                        card: '#1e293b',     // Slate 800 (å¡ç‰‡)
                        border: '#334155',   // Slate 700 (è¾¹æ¡†)
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background-color: #0f172a; color: #cbd5e1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* --- æ ¸å¿ƒï¼šCSS å˜é‡å®šä¹‰ (ç”± JS åŠ¨æ€ä¿®æ”¹) --- */
        :root {
            --theme-color: #3B82F6;       /* ä¸»é¢˜è‰² (é»˜è®¤è“) */
            --theme-dim: rgba(59, 130, 246, 0.15); /* æµ…è‰²èƒŒæ™¯ (é»˜è®¤è“) */
        }

        /* åŠ¨æ€ä¸»é¢˜åº”ç”¨ç±» */
        .dynamic-text { color: var(--theme-color); transition: color 0.3s; }
        .dynamic-bg { background-color: var(--theme-color); transition: background-color 0.3s; }
        .dynamic-bg-dim { background-color: var(--theme-dim); transition: background-color 0.3s; }
        .dynamic-border { border-color: var(--theme-color); transition: border-color 0.3s; }
        .dynamic-border-dim { border-color: rgba(255,255,255,0.1); transition: border-color 0.3s; }
        
        /* å¯¼èˆªæ¿€æ´»æ€ï¼šä¸‹è¾¹æ¡†é«˜äº® */
        .nav-item.active {
            background: rgba(255,255,255,0.03);
            border-bottom: 2px solid var(--theme-color);
            color: #fff;
        }
        
        /* AI æ¨¡æ€æ¡†ä¸¥è°¨é£æ ¼ */
        #decision-modal .modal-panel {
            border: 1px solid var(--theme-color);
            box-shadow: 0 0 40px -10px var(--theme-dim); /* æŸ”å’Œçš„åŒè‰²ç³»å…‰æ™• */
        }
        
        #decision-modal .modal-header {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: linear-gradient(90deg, var(--theme-dim) 0%, transparent 100%);
        }

        /* AI Markdown å†…å®¹æ’ç‰ˆ (ä¸¥è°¨æ¨¡å¼) */
        .ai-content h3 { 
            color: var(--theme-color); 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin-top: 1.5rem; 
            margin-bottom: 0.75rem; 
            display: flex; 
            align-items: center; 
        }
        .ai-content h3::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 16px;
            background-color: var(--theme-color);
            margin-right: 10px;
            border-radius: 2px;
        }
        .ai-content ul { list-style: none; padding-left: 0; margin-bottom: 1rem; }
        .ai-content li { 
            margin-bottom: 0.5rem; 
            padding-left: 1.5rem; 
            position: relative; 
            color: #e2e8f0; 
        }
        .ai-content li::before {
            content: 'â€¢';
            color: var(--theme-color);
            position: absolute;
            left: 0;
            font-weight: bold;
        }
        .ai-content strong { 
            color: #fff; 
            font-weight: 700; 
            border-bottom: 1px dashed var(--theme-color); /* è™šçº¿ä¸‹åˆ’çº¿å¼ºè°ƒ */
        }
        
        /* åŠ è½½åŠ¨ç”»è·Ÿéšä¸»é¢˜è‰² */
        .loader {
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 2px solid var(--theme-color);
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm" onkeydown="handleGlobalKeys(event)">

    <!-- 1. é¡¶éƒ¨å…¨å±€å¯¼èˆª -->
    <header class="h-14 bg-card border-b border-border flex items-center justify-between px-4 shrink-0 z-30 shadow-sm">
        <div class="flex items-center gap-6">
            <div class="text-lg font-bold tracking-wider text-white flex items-center gap-2">
                <!-- å›¾æ ‡é¢œè‰²è·Ÿéšæ¿å— -->
                <i class="fa-solid fa-layer-group dynamic-text"></i> 
                <span>SMCC</span>
                <span class="text-[10px] bg-white/10 text-gray-300 px-1.5 rounded font-normal">v4.0</span>
            </div>
            
            <nav class="flex h-14">
                <button onclick="switchTab('ot')" id="nav-ot" class="nav-item h-full px-5 flex items-center gap-2 transition-all border-b-2 border-transparent text-gray-400 hover:text-white">
                    <i class="fa-solid fa-server"></i> <span>OT æ•°æ®</span>
                </button>
                <button onclick="switchTab('workflow')" id="nav-workflow" class="nav-item h-full px-5 flex items-center gap-2 transition-all border-b-2 border-transparent text-gray-400 hover:text-white">
                    <i class="fa-solid fa-list-check"></i> <span>MES æ‰§è¡Œ</span>
                </button>
                <button onclick="switchTab('info')" id="nav-info" class="nav-item h-full px-5 flex items-center gap-2 transition-all border-b-2 border-transparent text-gray-400 hover:text-white">
                    <i class="fa-solid fa-file-waveform"></i> <span>PLM å·¥è‰º</span>
                </button>
                <button onclick="switchTab('finance')" id="nav-finance" class="nav-item h-full px-5 flex items-center gap-2 transition-all border-b-2 border-transparent text-gray-400 hover:text-white">
                    <i class="fa-solid fa-sack-dollar"></i> <span>FIN èµ„é‡‘</span>
                </button>
            </nav>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="generateGlobalBriefing()" class="dynamic-bg hover:opacity-90 text-white px-3 py-1.5 rounded-sm shadow-sm flex items-center gap-2 transition-all active:scale-95 text-xs font-semibold">
                <i class="fa-solid fa-wand-magic-sparkles"></i> 
                <span>ç”Ÿæˆç®€æŠ¥</span>
            </button>
            
            <div class="h-5 w-px bg-gray-700 mx-2"></div>

            <button onclick="openSettings()" class="w-8 h-8 rounded hover:bg-white/10 flex items-center justify-center transition-colors text-gray-400 hover:text-white">
                <i class="fa-solid fa-gear"></i>
            </button>
            
            <button onclick="toggleChat()" class="w-8 h-8 rounded hover:bg-white/10 flex items-center justify-center transition-colors text-gray-400 hover:text-white relative">
                <i class="fa-solid fa-comment-dots dynamic-text"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- 2. ä¾§è¾¹æ  -->
        <aside class="w-56 bg-card border-r border-border flex flex-col shrink-0 z-20">
            <div class="p-4 border-b border-border">
                <div class="text-[10px] font-bold text-gray-500 uppercase mb-3 tracking-wider">æ—¶é—´ç»´åº¦</div>
                <div class="space-y-1">
                    <button onclick="switchPeriod('daily')" id="btn-daily" class="period-btn w-full flex items-center justify-between px-3 py-2 rounded-sm text-gray-400 hover:bg-white/5 transition-colors">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-clock w-4 text-center"></i> æ—¥æŠ¥</span>
                        <span class="text-[10px] bg-black/20 px-1.5 rounded text-gray-500 font-mono">D</span>
                    </button>
                    <button onclick="switchPeriod('weekly')" id="btn-weekly" class="period-btn w-full flex items-center justify-between px-3 py-2 rounded-sm text-gray-400 hover:bg-white/5 transition-colors">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-week w-4 text-center"></i> å‘¨æŠ¥</span>
                        <span class="text-[10px] bg-black/20 px-1.5 rounded text-gray-500 font-mono">W</span>
                    </button>
                    <button onclick="switchPeriod('monthly')" id="btn-monthly" class="period-btn w-full flex items-center justify-between px-3 py-2 rounded-sm text-gray-400 hover:bg-white/5 transition-colors">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-days w-4 text-center"></i> æœˆæŠ¥</span>
                        <span class="text-[10px] bg-black/20 px-1.5 rounded text-gray-500 font-mono">M</span>
                    </button>
                </div>
            </div>

            <div class="flex-1 p-4 overflow-y-auto" id="drill-down-menu">
                <!-- åŠ¨æ€é’»å–èœå• -->
            </div>
            
            <div class="p-3 bg-black/20 text-[10px] text-gray-600 border-t border-border flex justify-between items-center">
                <span>Gemini API: <span id="api-status-text" class="text-gray-500">æœªé…ç½®</span></span>
            </div>
        </aside>

        <!-- 3. ä¸»å·¥ä½œåŒº -->
        <main class="flex-1 bg-dark relative flex flex-col overflow-hidden" id="main-content">
            <!-- åŠ¨æ€æ³¨å…¥å†…å®¹ -->
        </main>

        <!-- 4. æ¨¡æ€æ¡†ä¸æ‚¬æµ®çª— -->
        
        <!-- API è®¾ç½®å¼¹çª— -->
        <div id="settings-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-card w-full max-w-md rounded border border-border shadow-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-4 border-b border-border pb-2">ç³»ç»Ÿè®¾ç½®</h3>
                <div class="mb-4">
                    <label class="block text-gray-400 text-xs mb-2">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full bg-dark border border-border rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500 placeholder-gray-600 text-xs" placeholder="è¾“å…¥ Key...">
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeSettings()" class="px-4 py-1.5 rounded border border-border text-gray-300 hover:bg-white/5 text-xs">å–æ¶ˆ</button>
                    <button onclick="saveApiKey()" class="dynamic-bg text-white px-4 py-1.5 rounded hover:opacity-90 text-xs">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- èŠå¤©çª—å£ -->
        <div id="chat-widget" class="fixed bottom-4 right-4 w-80 h-[450px] bg-card border border-border rounded shadow-2xl flex flex-col z-40 transform translate-y-[120%] transition-transform duration-300">
            <div class="dynamic-bg-dim px-4 py-3 border-b border-border flex justify-between items-center shrink-0">
                <div class="font-bold text-gray-200 flex items-center gap-2"><i class="fa-solid fa-robot dynamic-text"></i> æˆ˜æƒ…åŠ©æ‰‹</div>
                <button onclick="toggleChat()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-dark/50">
                <div class="flex gap-3">
                    <div class="w-6 h-6 rounded-full dynamic-bg flex items-center justify-center shrink-0 text-white text-[10px]"><i class="fa-solid fa-robot"></i></div>
                    <div class="bg-white/5 p-2 rounded text-gray-300 text-xs border border-white/5">æŒ‡æŒ¥å®˜ï¼Œæˆ‘æ˜¯æ‚¨çš„å†³ç­–åŠ©æ‰‹ã€‚è¯·æŒ‡ç¤ºã€‚</div>
                </div>
            </div>
            <div class="p-3 border-t border-border bg-card">
                <div class="flex gap-2 relative">
                    <input type="text" id="chat-input" placeholder="è¾“å…¥æŒ‡ä»¤..." class="w-full bg-dark border border-border rounded px-3 py-2 text-white focus:outline-none focus:border-opacity-50 dynamic-border pr-8 text-xs" onkeydown="if(event.key==='Enter') sendChatMessage()">
                    <button onclick="sendChatMessage()" class="absolute right-2 top-2 dynamic-text hover:text-white"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <!-- å†³ç­–æ¨æ¼”/ç®€æŠ¥æ¨¡æ€æ¡† (ä¸¥è°¨é£æ ¼) -->
        <div id="decision-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-md">
            <!-- modal-panel ç±»ç”¨äºåº”ç”¨åŠ¨æ€è¾¹æ¡†å’Œå…‰æ™• -->
            <div class="modal-panel bg-card w-full max-w-4xl max-h-[90vh] rounded flex flex-col overflow-hidden animate-fade-in-up">
                <!-- æ ‡é¢˜æ ï¼šä½¿ç”¨æ¸å˜èƒŒæ™¯ -->
                <div class="modal-header px-6 py-4 flex justify-between items-center shrink-0">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2" id="modal-title">
                        <i class="fa-solid fa-brain dynamic-text"></i> 
                        <span>AI å†³ç­–æ¨æ¼”</span>
                    </h2>
                    <div class="flex gap-4">
                        <button onclick="closeModal()" class="text-gray-500 hover:text-white transition"><i class="fa-solid fa-times text-lg"></i></button>
                    </div>
                </div>
                <!-- å†…å®¹åŒºï¼šæ·±è‰²èƒŒæ™¯ï¼Œçªå‡ºæ–‡å­— -->
                <div class="p-8 overflow-y-auto ai-content bg-dark" id="modal-content">
                    <!-- AI å†…å®¹æ³¨å…¥åŒº -->
                </div>
                <!-- åº•éƒ¨æ“ä½œæ  -->
                <div class="px-6 py-3 border-t border-border bg-card/50 flex justify-between items-center text-xs text-gray-500">
                    <span>ç”± Gemini 2.5 Flash æä¾›ç®—åŠ›æ”¯æŒ</span>
                    <button onclick="closeModal()" class="px-4 py-1.5 rounded border border-border text-gray-300 hover:bg-white/5">å…³é—­æŠ¥å‘Š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. å…¨å±€é…ç½®ä¸ä¸¥è°¨è‰²å½©æ˜ å°„ ---
        let apiKey = localStorage.getItem('smcc_gemini_key') || "";
        
        // å®šä¹‰æ›´ä¸“ä¸šã€ä½é¥±å’Œåº¦çš„å·¥ä¸šè‰²å½©
        const themeMap = {
            ot: { 
                hex: '#3B82F6', // Blue-500
                dim: 'rgba(59, 130, 246, 0.1)' 
            },
            workflow: { 
                hex: '#10B981', // Emerald-500
                dim: 'rgba(16, 185, 129, 0.1)' 
            },
            info: { 
                hex: '#8B5CF6', // Violet-500
                dim: 'rgba(139, 92, 246, 0.1)' 
            },
            finance: { 
                hex: '#F59E0B', // Amber-500
                dim: 'rgba(245, 158, 11, 0.1)' 
            }
        };

        const state = { tab: 'ot', period: 'daily' };

        // --- 2. æ¨¡æ‹Ÿæ•°æ® (ä¿æŒä¸°å¯Œæ€§) ---
        const reportData = {
            ot: {
                drill: [{name:'OEEåˆ†æ', icon:'fa-chart-pie', key:'O'}, {name:'MTBFè¶‹åŠ¿', icon:'fa-heart-pulse', key:'M'}, {name:'èƒ½è€—å®¡è®¡', icon:'fa-bolt', key:'E'}],
                content: {
                    daily: {
                        kpi: [{l:'OEE', v:'78.4%', t:'-2.1%'}, {l:'åœæœºæ—¶é—´', v:'25m', t:'+10m'}, {l:'èƒ½è€—å•è€—', v:'1.2kW', t:'-5%'}],
                        events: [{t:'09:15', m:'2å·æœºä¸»è½´è¿‡çƒ­æŠ¥è­¦', type:'alert'}, {t:'10:30', m:'ç©ºå‹æœºè´Ÿè½½æ³¢åŠ¨', type:'warn'}],
                        chartTitle: 'ä»Šæ—¥è®¾å¤‡OEEæ—¶åºå›¾', chartType: 'line',
                        chartData: { labels: ['8:00','10:00','12:00','14:00','16:00'], data: [85, 40, 90, 88, 60] },
                        context: "10:00 ä¸»è½´è¿‡çƒ­å¯¼è‡´ OEE éª¤é™ã€‚å»ºè®®æ£€æŸ¥å†·å´æ¶²æµé‡åŠæ¶¦æ»‘ç³»ç»ŸçŠ¶æ€ã€‚"
                    },
                    weekly: {
                        kpi: [{l:'MTBF', v:'142h', t:'-12h'}, {l:'PMè¾¾æˆç‡', v:'98%', t:'+2%'}, {l:'ç»´ä¿®è´¹', v:'Â¥12k', t:'+2k'}],
                        events: [{t:'å‘¨ä¸€', m:'ä¼ºæœç”µæœºæ›´æ¢', type:'info'}],
                        chartTitle: 'æœ¬å‘¨æ•…éšœç±»å‹å¸•ç´¯æ‰˜', chartType: 'bar',
                        chartData: { labels: ['ç”µæ°”','æœºæ¢°','æ¶²å‹','è½¯ä»¶'], data: [12, 8, 5, 2] },
                        context: "ç”µæ°”æ•…éšœå æ¯”æœ€é«˜ï¼Œé›†ä¸­åœ¨è€åŒ–çº¿è·¯ã€‚å»ºè®®å®‰æ’çƒ­æˆåƒä¸“é¡¹æ£€æµ‹ã€‚"
                    },
                    monthly: {
                        kpi: [{l:'TCO', v:'Â¥1.2M', t:'+8%'}, {l:'èµ„äº§åˆ©ç”¨', v:'85%', t:'0%'}, {l:'å¤§ä¿®', v:'3æ¬¡', t:'+1'}],
                        events: [], chartTitle: 'èµ„äº§å…¨ç”Ÿå‘½å‘¨æœŸæˆæœ¬', chartType: 'line',
                        chartData: { labels: ['W1','W2','W3','W4'], data: [20, 25, 22, 35] },
                        context: "æœˆæœ«å¤§ä¿®å¯¼è‡´ç»´ä¿®æˆæœ¬æ¿€å¢ï¼Œä½†æœ‰æ•ˆé™ä½äº†éè®¡åˆ’åœæœºé£é™©ã€‚"
                    }
                }
            },
            workflow: {
                drill: [{name:'æ’äº§è¾¾æˆ', icon:'fa-tasks', key:'S'}, {name:'WIPåˆ†æ', icon:'fa-boxes-stacked', key:'W'}, {name:'äººæ•ˆåˆ†æ', icon:'fa-user-clock', key:'P'}],
                content: {
                    daily: {
                        kpi: [{l:'è¾¾æˆç‡', v:'94%', t:'-4%'}, {l:'WIPç§¯å‹', v:'12æ‰¹', t:'+2'}, {l:'äººæ•ˆ', v:'420pc', t:'+10'}],
                        events: [{t:'08:00', m:'æ—©ç­ç¼ºå‹¤ç‡5%', type:'warn'}, {t:'11:00', m:'å·¥åº3ç¼ºæ–™', type:'alert'}],
                        chartTitle: 'å·¥å•æ‰§è¡Œè¿›åº¦', chartType: 'doughnut',
                        chartData: { labels: ['å®Œå·¥','åœ¨åˆ¶','æœªå¼€'], data: [65, 25, 10] },
                        context: "ç¼ºå‹¤å’Œç¼ºæ–™å¯¼è‡´å·¥åº3ç“¶é¢ˆã€‚å»ºè®®ä¸´æ—¶è°ƒæ‹¨äººå‘˜å¹¶å‚¬æ–™ã€‚"
                    },
                    weekly: { /* çœç•¥ä»¥èŠ‚çœé•¿åº¦ï¼Œé€»è¾‘åŒä¸Š */ 
                        kpi: [{l:'OTD', v:'96%', t:'+1%'}, {l:'FPY', v:'99%', t:'0%'}, {l:'SMED', v:'20m', t:'-5m'}],
                        events: [], chartTitle: 'å‘¨äº§é‡è¶‹åŠ¿', chartType: 'bar',
                        chartData: { labels: ['M','T','W','T','F'], data: [100,120,110,130,125] },
                        context: "å‘¨å››äº§é‡åˆ›æ–°é«˜ï¼Œæ¢å‹ä¼˜åŒ–æ•ˆæœæ˜¾è‘—ã€‚"
                    },
                    monthly: {
                        kpi: [{l:'äº¤ä»˜ç‡', v:'92%', t:'-3%'}, {l:'äº§å€¼', v:'Â¥50M', t:'+5%'}, {l:'è¿”å·¥', v:'1.2%', t:'-0.1%'}],
                        events: [], chartTitle: 'å„äº§çº¿äº§å€¼è´¡çŒ®', chartType: 'pie',
                        chartData: { labels: ['L1','L2','L3'], data: [40, 35, 25] },
                        context: "L1äº§çº¿è´¡çŒ®æœ€å¤§ï¼ŒL3å—é™äºè®¾å¤‡è€åŒ–äº§èƒ½å—é™ã€‚"
                    }
                }
            },
            info: { /* çœç•¥ */
                drill: [{name:'BOM', icon:'fa-list-check', key:'B'}, {name:'ECN', icon:'fa-code-branch', key:'C'}, {name:'å·¥è‰º', icon:'fa-flask', key:'T'}],
                content: {
                    daily: {
                        kpi: [{l:'BOMå·®å¼‚', v:'1.2%', t:'+0.5%'}, {l:'é»„é‡‘æ‰¹æ¬¡', v:'0.9', t:'0'}, {l:'ECNå¾…åŠ', v:'2', t:'+1'}],
                        events: [{t:'09:00', m:'é…æ–¹V2.1æ ¡éªŒå¤±è´¥', type:'warn'}],
                        chartTitle: 'æŠ•æ–™åå·®ç›‘æ§', chartType: 'line',
                        chartData: { labels: ['T1','T2','T3','T4'], data: [10, 10.1, 10.5, 10] },
                        context: "æŠ•æ–™åå·®å¯èƒ½å¯¼è‡´äº§å“ä¸€è‡´æ€§é—®é¢˜ã€‚å»ºè®®æ ¡å‡†ç§°é‡æ¨¡å—ã€‚"
                    },
                    weekly: { kpi:[], events:[], chartData:{labels:[],data:[]}, context:""},
                    monthly: { kpi:[], events:[], chartData:{labels:[],data:[]}, context:""}
                } 
            },
            finance: { /* çœç•¥ */ 
                drill: [{name:'æˆæœ¬', icon:'fa-money-bill-trend-up', key:'C'}, {name:'CCC', icon:'fa-rotate', key:'R'}, {name:'æ¯›åˆ©', icon:'fa-hand-holding-dollar', key:'P'}],
                content: {
                    daily: {
                        kpi: [{l:'æ—¥æˆæœ¬', v:'-Â¥5k', t:'æ¶åŒ–'}, {l:'æ–™å·®', v:'+3%', t:''}, {l:'å·¥å·®', v:'-1%', t:''}],
                        events: [{t:'16:00', m:'Batch#405 è´µé‡‘å±è¶…è€—', type:'alert'}],
                        chartTitle: 'æˆæœ¬æ–¹å·®åˆ†è§£', chartType: 'bar',
                        chartData: { labels: ['é‡å·®','ä»·å·®','æ•ˆç‡','èƒ½æº'], data: [-4000, 500, 1000, -200] },
                        context: "é‡å·®ï¼ˆè¶…è€—ï¼‰æ˜¯ä¸»è¦äºæŸæºã€‚å»ºè®®å†»ç»“è¯¥æ‰¹æ¬¡ï¼Œå·¥è‰ºäººå‘˜ä»‹å…¥åˆ†æã€‚"
                    },
                    weekly: { kpi:[], events:[], chartData:{labels:[],data:[]}, context:""},
                    monthly: { kpi:[], events:[], chartData:{labels:[],data:[]}, context:""}
                }
            }
        };

        // --- 3. æ ¸å¿ƒé€»è¾‘ ---

        function init() {
            updateApiStatus();
            render();
        }

        function render() {
            const theme = themeMap[state.tab];
            const data = reportData[state.tab].content[state.period] || reportData[state.tab].content.daily;

            // å…³é”®ï¼šåŠ¨æ€æ³¨å…¥ CSS å˜é‡ï¼Œæ§åˆ¶å…¨å±€å’Œæ¨¡æ€æ¡†é¢œè‰²
            const root = document.documentElement;
            root.style.setProperty('--theme-color', theme.hex);
            root.style.setProperty('--theme-dim', theme.dim);

            // æ›´æ–°å¯¼èˆª
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${state.tab}`).classList.add('active');

            // æ›´æ–°æ—¶é—´ç»´åº¦
            document.querySelectorAll('.period-btn').forEach(el => {
                el.classList.remove('active');
                el.style.borderLeftColor = 'transparent';
                el.style.color = '#94a3b8';
                el.style.backgroundColor = 'transparent';
            });
            const activePeriod = document.getElementById(`btn-${state.period}`);
            activePeriod.classList.add('active');
            activePeriod.style.borderLeftColor = theme.hex;
            activePeriod.style.color = '#fff';
            activePeriod.style.backgroundColor = 'rgba(255,255,255,0.05)';

            // æ›´æ–°é’»å–èœå•
            const drillHTML = reportData[state.tab].drill.map(d => `
                <button class="w-full text-left px-3 py-2 rounded-sm text-gray-400 hover:bg-white/5 transition-colors flex justify-between items-center group">
                    <span class="flex items-center gap-2"><i class="fa-solid ${d.icon} w-4 text-center dynamic-text"></i> ${d.name}</span>
                    <span class="text-[10px] border border-gray-700 px-1 rounded opacity-50 font-mono group-hover:border-gray-500">${d.key}</span>
                </button>
            `).join('');
            document.getElementById('drill-down-menu').innerHTML = `<div class="text-[10px] font-bold text-gray-500 uppercase mt-4 mb-2 px-4 tracking-wider">æ·±åº¦é’»å–</div><div class="space-y-1 px-2">${drillHTML}</div>`;

            // æ¸²æŸ“ä¸»ç½‘æ ¼
            const main = document.getElementById('main-content');
            main.innerHTML = `
                <div class="grid grid-cols-12 grid-rows-12 gap-4 p-4 h-full">
                    ${data.kpi.map(k => `
                        <div class="col-span-12 md:col-span-4 row-span-2 bg-card rounded-sm p-4 border-l-2 dynamic-border shadow-sm flex flex-col justify-between">
                            <div class="text-xs text-gray-400 uppercase tracking-wide flex justify-between">
                                ${k.l} <i class="fa-solid fa-ellipsis text-gray-600 hover:text-white cursor-pointer"></i>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <span class="text-2xl font-bold text-white">${k.v}</span>
                                ${k.t ? `<span class="text-xs ${k.t.includes('-')||k.t.includes('æ¶åŒ–') ? 'text-red-400' : 'text-green-400'}">${k.t}</span>` : ''}
                            </div>
                        </div>
                    `).join('')}

                    <div class="col-span-12 row-span-1 bg-card/30 rounded-sm flex items-center px-4 border border-border">
                        <div class="text-xs font-bold dynamic-text mr-4 shrink-0 flex items-center gap-1">
                            <i class="fa-solid fa-bell"></i> æ¶ˆæ¯
                        </div>
                        <div class="flex-1 overflow-hidden relative h-full flex items-center">
                            <div class="whitespace-nowrap text-sm text-gray-400">
                                ${data.events.map(e => `<span class="mr-6 font-mono text-xs opacity-60">[${e.t}]</span> <span class="${e.type==='alert'?'text-red-400':'text-yellow-400'}">${e.m}</span>`).join('<span class="mx-4 text-gray-700">|</span>') || 'ç³»ç»Ÿè¿è¡Œå¹³ç¨³ã€‚'}
                            </div>
                        </div>
                    </div>

                    <div class="col-span-12 row-span-9 bg-card rounded-sm p-5 border border-border shadow-md relative flex flex-col">
                        <div class="flex justify-between items-center mb-4 shrink-0">
                            <h3 class="text-white font-bold flex items-center gap-2 text-sm">
                                <i class="fa-solid fa-chart-line dynamic-text"></i> ${data.chartTitle}
                            </h3>
                            <button onclick="triggerAIDecision()" class="dynamic-bg hover:opacity-90 text-white px-3 py-1.5 rounded-sm text-xs font-semibold flex items-center gap-2 shadow-sm transition-all">
                                <i class="fa-solid fa-brain"></i> AI å†³ç­–æ¨æ¼”
                            </button>
                        </div>
                        <div class="flex-1 relative w-full overflow-hidden">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            renderChart(data, theme);
        }

        // --- 4. å›¾è¡¨æ¸²æŸ“ ---
        let chartInstance = null;
        function renderChart(data, theme) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, theme.hex + '66'); // 40% opacity
            gradient.addColorStop(1, theme.hex + '00'); // 0% opacity

            const config = {
                type: data.chartType || 'line',
                data: {
                    labels: data.chartData.labels,
                    datasets: [{
                        label: 'æ•°å€¼',
                        data: data.chartData.data,
                        borderColor: theme.hex,
                        backgroundColor: data.chartType === 'line' ? gradient : theme.hex,
                        borderWidth: 2,
                        pointBackgroundColor: '#1e293b',
                        pointBorderColor: theme.hex,
                        pointRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#334155', drawBorder: false }, ticks: { color: '#64748b', font: {size: 10} } },
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: {size: 10} } }
                    }
                }
            };
            
            if(data.chartType === 'doughnut' || data.chartType === 'pie') {
                config.data.datasets[0].backgroundColor = [theme.hex, '#475569', '#1e293b'];
                config.data.datasets[0].borderColor = '#1e293b';
                delete config.options.scales;
            }

            chartInstance = new Chart(ctx, config);
        }

        // --- 5. Gemini AI é€»è¾‘ ---
        async function callGemini(prompt) {
            if (!apiKey) {
                return new Promise(resolve => setTimeout(() => resolve(`
                    <h3>âš ï¸ æ¼”ç¤ºæ¨¡å¼</h3>
                    <p>è¯·ç‚¹å‡»é¡¶éƒ¨ <i class="fa-solid fa-gear"></i> é…ç½®æ‚¨çš„ Gemini API Key ä»¥è·å–å®æ—¶ AI åˆ†æã€‚</p>
                    <p><strong>æ¨¡æ‹Ÿç»“è®ºï¼š</strong> å½“å‰æ£€æµ‹åˆ°æ•°æ®æ³¢åŠ¨ï¼Œå»ºè®®å…³æ³¨ä¸Šè¿° KPI å˜åŒ–è¶‹åŠ¿ã€‚</p>
                `), 800));
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error(e);
                return "<h3>ğŸš« è¿æ¥é”™è¯¯</h3><p>æ— æ³•è¿æ¥ Gemini APIï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®ã€‚</p>";
            }
        }

        async function triggerAIDecision() {
            const modal = document.getElementById('decision-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            content.innerHTML = '<div class="flex flex-col items-center justify-center py-16 gap-4"><div class="loader"></div><div class="text-gray-500 font-mono text-xs">æ­£åœ¨è¿›è¡Œå†³ç­–æ¨æ¼”...</div></div>';
            
            const data = reportData[state.tab].content[state.period] || reportData[state.tab].content.daily;
            const prompt = `
                è§’è‰²ï¼šå·¥ä¸šæŒ‡æŒ¥ä¸­å¿ƒå†³ç­–å¼•æ“ã€‚
                åœºæ™¯ï¼š${state.tab.toUpperCase()}æ¿å— - ${state.period.toUpperCase()}ã€‚
                æ•°æ®ï¼š${JSON.stringify(data.kpi)}ã€‚
                äº‹ä»¶ï¼š${JSON.stringify(data.events)}ã€‚
                èƒŒæ™¯ï¼š${data.context}ã€‚
                è¦æ±‚ï¼šè¾“å‡º HTMLï¼Œä¸åŒ…å« markdown ä»£ç å—æ ‡è®°ã€‚
                ç»“æ„ï¼š
                1. <h3>æ€åŠ¿æ„ŸçŸ¥</h3>ï¼šç®€è¿°æ ¸å¿ƒé—®é¢˜ã€‚
                2. <h3>æ ¹å› åˆ†æ</h3>ï¼šåˆ†æåŸå› ã€‚
                3. <h3>è¡ŒåŠ¨å»ºè®®</h3>ï¼šåˆ—å‡º 2 æ¡å¸¦æœ‰ <strong>åŠ ç²—é‡ç‚¹</strong> çš„å»ºè®®ã€‚
            `;
            const html = await callGemini(prompt);
            content.innerHTML = html;
        }

        async function generateGlobalBriefing() {
            // ç®€æŠ¥ä½¿ç”¨é»˜è®¤è“è‰²æˆ–ç‰¹å®šâ€œæŒ‡æŒ¥è‰²â€ï¼Œè¿™é‡Œä½¿ç”¨å½“å‰ Tab è‰²ä¿æŒä¸€è‡´æ€§ï¼Œæˆ–å¼ºåˆ¶è“è‰²
            // ä¸ºäº†ä¸¥è°¨ï¼Œå»ºè®®ä¿æŒå½“å‰ Tab è‰²ï¼Œä½“ç°â€œä»å½“å‰è§†è§’å‡ºå‘çš„å…¨å±€æŠ¥å‘Šâ€
            const modal = document.getElementById('decision-modal');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-title').innerHTML = '<i class="fa-solid fa-file-contract dynamic-text"></i> å…¨åŸŸæŒ‡æŒ¥ç®€æŠ¥';
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="flex flex-col items-center justify-center py-16 gap-4"><div class="loader"></div><div class="text-gray-500 font-mono text-xs">æ­£åœ¨ç»¼åˆå…¨åŸŸæ•°æ®...</div></div>';
            
            let context = "";
            ['ot','workflow','info','finance'].forEach(t => {
                const d = reportData[t].content.daily;
                context += `[${t}] KPI:${JSON.stringify(d.kpi)}\n`;
            });

            const prompt = `
                è§’è‰²ï¼šå·¥å‚æŒ‡æŒ¥å®˜å‚è°‹ã€‚
                ä»»åŠ¡ï¼šç”Ÿæˆå…¨åŸŸäº¤æ¥ç­ç®€æŠ¥ï¼ˆHTMLï¼‰ã€‚
                æ•°æ®ï¼š${context}
                ç»“æ„ï¼š
                1. <h3>è¿è¥ç»¼è¿°</h3>ï¼šæ•´ä½“è¯„ä»·ã€‚
                2. <h3>é‡ç‚¹å…³æ³¨</h3>ï¼šåˆ—å‡º2ä¸ªé£é™©ç‚¹ã€‚
                3. <h3>æŒ‡ä»¤</h3>ï¼šä¸‹ä¸ªç­æ¬¡æ‰§è¡Œé‡ç‚¹ã€‚
            `;
            const html = await callGemini(prompt);
            content.innerHTML = html;
        }

        // --- 6. åŸºç¡€äº¤äº’ ---
        function switchTab(t) { state.tab = t; render(); }
        function switchPeriod(p) { state.period = p; render(); }
        
        function openSettings() {
            document.getElementById('api-key-input').value = apiKey;
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveApiKey() {
            const val = document.getElementById('api-key-input').value.trim();
            if(val) { apiKey = val; localStorage.setItem('smcc_gemini_key', apiKey); updateApiStatus(); closeSettings(); }
        }
        function updateApiStatus() {
            const el = document.getElementById('api-status-text');
            el.innerText = apiKey ? 'å·²é…ç½®' : 'æœªé…ç½®';
            el.className = apiKey ? 'text-emerald-500 font-bold' : 'text-gray-500';
        }

        function toggleChat() { 
            const el = document.getElementById('chat-widget');
            el.style.transform = el.style.transform === 'translateY(0%)' ? 'translateY(120%)' : 'translateY(0%)';
        }
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const msgs = document.getElementById('chat-messages');
            const val = input.value.trim();
            if(!val) return;
            msgs.innerHTML += `<div class="bg-white/10 p-2 rounded text-gray-200 text-xs self-end text-right border border-white/5 ml-8">${val}</div>`;
            input.value = '';
            const loadingId = Date.now();
            msgs.innerHTML += `<div id="${loadingId}" class="bg-gray-800 p-2 rounded text-gray-400 self-start mr-8 text-xs flex items-center gap-2"><div class="loader w-3 h-3 border-2"></div> ...</div>`;
            const reply = await callGemini(val);
            document.getElementById(loadingId).innerHTML = reply;
        }
        
        function closeModal() { document.getElementById('decision-modal').classList.add('hidden'); }
        
        function handleGlobalKeys(e) {
            if(e.altKey && e.key>='1' && e.key<='4') switchTab(['ot','workflow','info','finance'][parseInt(e.key)-1]);
            if(e.key==='Escape') { closeModal(); closeSettings(); document.getElementById('chat-widget').style.transform='translateY(120%)'; }
        }

        init();
    </script>
</body>
</html>