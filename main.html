<!-- 
Palette: "Future Tech Vibrant"
Primary: #4F46E5 (Indigo 600)
Secondary: #06B6D4 (Cyan 500)
Accent: #F59E0B (Amber 500)
Success: #10B981 (Emerald 500)
Danger: #EF4444 (Red 500)
Background: #F3F4F6 (Gray 100)
Card Bg: #FFFFFF

Plan Narrative & Structure:
1. Header: Introduction to the "AI Intelligent Decision System" context for Mid-sized Manufacturing in Yangtze Delta.
2. AI Executive Briefing: A new section powered by Gemini to generate summaries.
3. Daily Tactical View: Focus on MES (Production) and WMS (Logistics) for immediate issue resolution.
4. Weekly Operational View: Efficiency trends (OEE), Order Fulfillment (ERP), and Quality Control.
5. Monthly Strategic View: Financial Health (Cash Flow), Cost Attribution, and Risk Radar.
6. Data Lineage Flow: HTML/CSS diagram showing flow from Source Systems -> AI -> Decision Reports.

Visualization Choices (NO SVG):
1. Daily Equipment Status -> Goal: Inform -> Doughnut Chart (Chart.js)
2. Daily Defect Analysis -> Goal: Compare -> Bar Chart (Chart.js)
3. Weekly Plan vs Actual -> Goal: Compare -> Stacked/Grouped Bar (Chart.js)
4. Monthly Cost Composition -> Goal: Compare -> Pie Chart (Chart.js)
5. Strategic Risk Radar -> Goal: Relationships/Multi-variable -> Radar Chart (Chart.js)
6. Process Flow -> Goal: Organize -> CSS Flexbox/Grid
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•¿ä¸‰è§’å·¥ä¸šåˆ¶é€ ä¼ä¸š - AIæ™ºèƒ½å†³ç­–é©¾é©¶èˆ±</title>
    
    <!-- Vercel Web Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #F3F4F6;
            color: #1F2937;
        }
        /* Chart Container Styling Rules - STRICT ADHERENCE */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Base height */
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        /* Custom Flow Diagram Styling (No SVG/Mermaid) */
        .flow-box {
            background: white;
            border-left: 4px solid #4F46E5;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-align: center;
            font-weight: bold;
            color: #374151;
            position: relative;
        }
        .flow-arrow {
            font-size: 2rem;
            color: #9CA3AF;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Loading Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4F46E5;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ai-result-box {
            background-color: #F0FDF4; /* Green-50 */
            border: 1px solid #BBF7D0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #14532D;
            display: none; /* Hidden by default */
        }
        /* Chat Widget Styles */
        .chat-widget {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 350px;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 100;
            border: 1px solid #E5E7EB;
            transform: translateY(120%);
            transition: transform 0.3s ease-in-out;
        }
        .chat-widget.open {
            transform: translateY(0);
        }
        .chat-header {
            background: #4F46E5;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        .chat-body {
            height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background: #F9FAFB;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .chat-footer {
            padding: 0.75rem;
            border-top: 1px solid #E5E7EB;
            background: white;
            display: flex;
            gap: 0.5rem;
        }
        .chat-message {
            max-width: 80%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .chat-message.user {
            align-self: flex-end;
            background: #4F46E5;
            color: white;
            border-bottom-right-radius: 0;
        }
        .chat-message.ai {
            align-self: flex-start;
            background: #E5E7EB;
            color: #1F2937;
            border-bottom-left-radius: 0;
        }
        .chat-toggle-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: #4F46E5;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 101;
            transition: transform 0.2s;
            font-size: 1.5rem;
        }
        .chat-toggle-btn:hover {
            transform: scale(1.05);
        }
        /* Email Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Navigation / Header -->
    <header class="bg-indigo-600 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">æ™ºé€  Â· å†³ç­–è§†ç•Œ</h1>
                <p class="text-indigo-200 text-sm">é•¿ä¸‰è§’ä¸­å‹ä¼ä¸š AI æ•°æ®åˆ†æä¸å†³ç­–æ”¯æŒç³»ç»Ÿ</p>
            </div>
            <div class="hidden md:block text-right">
                <span class="bg-indigo-700 px-3 py-1 rounded text-xs font-mono block mb-1">å¹´äº§å€¼: 2-5äº¿ RMB</span>
                <span class="text-xs text-indigo-300">Powered by Gemini AI âœ¨</span>
            </div>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="container mx-auto px-4 py-8 grid grid-cols-1 md:grid-cols-12 gap-8">

        <!-- Introduction Section -->
        <section class="md:col-span-12 bg-white rounded-xl shadow-md p-8 border-l-8 border-cyan-500">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">ä¼ä¸šæ•°æ®èµ„äº§çš„ AI ä»·å€¼è½¬åŒ–</h2>
            <p class="text-gray-600 text-lg leading-relaxed mb-6">
                é’ˆå¯¹é•¿ä¸‰è§’åœ°åŒºå¹´é”€å”®é¢åœ¨ 2-5 äº¿äººæ°‘å¸çš„å…¸å‹åˆ¶é€ ä¼ä¸šï¼Œæˆ‘ä»¬å·²æˆåŠŸæ‰“é€š <strong>MES (ç”Ÿäº§)ã€ERP (èµ„æº)ã€WMS (ä»“å‚¨) åŠ è´¢åŠ¡ç³»ç»Ÿ</strong>ã€‚
                æœ¬æŠ¥å‘Šä¸ä»…å±•ç¤ºæ•°æ®ï¼Œæ›´é€šè¿‡ <strong>Gemini AI å¼•æ“</strong> å®æ—¶ä¸ºæ‚¨æä¾›å†³ç­–å»ºè®®ã€‚
            </p>
            
            <!-- AI Executive Briefing Feature -->
            <div class="bg-indigo-50 rounded-lg p-6 border border-indigo-100">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h3 class="text-xl font-bold text-indigo-900 flex items-center">
                        <span class="text-2xl mr-2">ğŸ¤–</span> Gemini æ™¨ä¼šæ™ºèƒ½ç®€æŠ¥
                    </h3>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="generateBriefing()" id="btn-briefing" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow transition flex items-center text-sm">
                            <span>âœ¨ ç”Ÿæˆä»Šæ—¥ç®€æŠ¥</span>
                        </button>
                        <button onclick="speakBriefing()" id="btn-speak" class="bg-white hover:bg-gray-100 text-indigo-600 border border-indigo-200 font-bold py-2 px-4 rounded shadow transition hidden flex items-center text-sm">
                            <span>ğŸ”Š æ’­æŠ¥</span>
                        </button>
                        <button onclick="generateEmailReport()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded shadow transition flex items-center text-sm ml-2">
                            <span>ğŸ“§ ç”Ÿæˆå‘¨æŠ¥é‚®ä»¶</span>
                        </button>
                    </div>
                </div>
                <div id="briefing-content" class="text-indigo-800 text-md hidden">
                    <!-- Content will be injected here -->
                </div>
                <div id="briefing-loader" class="hidden py-4 text-indigo-500 flex items-center">
                    <div class="loader"></div> æ­£åœ¨åˆ†æå…¨å‚ 42 ä¸ªæ•°æ®ç»´åº¦ï¼Œç”Ÿæˆå†³ç­–å»ºè®®...
                </div>
            </div>
        </section>

        <!-- SECTION 1: DAILY TACTICAL REPORT (MES & WMS Focus) -->
        <div class="md:col-span-12 mt-4">
            <div class="flex items-center space-x-2 mb-2">
                <span class="text-2xl">ğŸ“…</span>
                <h3 class="text-2xl font-bold text-gray-800">æ—¥æŠ¥è¡¨ï¼šç”Ÿäº§ç°åœºä¸ç‰©æµå“åº”</h3>
            </div>
            <p class="text-gray-600 mb-6">
                <strong>æ ¸å¿ƒåœºæ™¯ï¼š</strong> ç­ç»„é•¿ä¸ç”Ÿäº§ç»ç†æ™¨ä¼šã€‚AI å®æ—¶åˆ†æè®¾å¤‡ç¨¼åŠ¨ç‡ï¼ˆOEEï¼‰ä¸è‰¯ç‡å¼‚å¸¸ã€‚
            </p>
        </div>

        <!-- Chart 1: Equipment Status -->
        <div class="md:col-span-6 bg-white rounded-xl shadow-md p-6 relative">
            <div class="flex justify-between items-start border-b pb-2 mb-4">
                <h4 class="text-lg font-semibold text-gray-700">å®æ—¶è®¾å¤‡ç»¼åˆæ•ˆç‡ (MES)</h4>
                <button onclick="analyzeChart('equipment')" class="text-xs bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-2 py-1 rounded transition flex items-center">
                    âœ¨ AI è¯Šæ–­
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-4">
                å½“å‰è½¦é—´ 42 å°ä¸»è¦è®¾å¤‡çš„å®æ—¶è¿è¡ŒçŠ¶æ€åˆ†å¸ƒã€‚
            </p>
            <div class="chart-container">
                <canvas id="dailyEquipmentChart"></canvas>
            </div>
            <div class="mt-4 flex justify-between text-sm text-gray-600">
                <span>ğŸŸ¢ æ­£å¸¸: 65%</span>
                <span class="text-red-500">ğŸ”´ æ•…éšœ: 12%</span>
                <span class="text-yellow-500">ğŸŸ¡ å¾…æ–™: 23%</span>
            </div>
            <!-- AI Output Area -->
            <div id="ai-equipment-result" class="ai-result-box"></div>
        </div>

        <!-- Chart 2: Top Quality Issues -->
        <div class="md:col-span-6 bg-white rounded-xl shadow-md p-6 relative">
            <div class="flex justify-between items-start border-b pb-2 mb-4">
                <h4 class="text-lg font-semibold text-gray-700">æ˜¨æ—¥ä¸è‰¯å“å½’å› åˆ†æ (Quality)</h4>
                <button onclick="analyzeChart('defect')" class="text-xs bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-2 py-1 rounded transition flex items-center">
                    âœ¨ AI æ ¹å› åˆ†æ
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-4">
                åŸºäºæœºå™¨è§†è§‰ä¸äººå·¥è´¨æ£€æ•°æ®ã€‚AI èšç±»åˆ†ææ˜¾ç¤ºï¼Œâ€œè¡¨é¢å–·æ¶‚ä¸å‡åŒ€â€æ˜¯ä¸»è¦é—®é¢˜ã€‚
            </p>
            <div class="chart-container">
                <canvas id="dailyDefectChart"></canvas>
            </div>
             <!-- AI Output Area -->
             <div id="ai-defect-result" class="ai-result-box"></div>
        </div>

        <!-- SECTION 2: WEEKLY OPERATIONAL REPORT (ERP & Efficiency Focus) -->
        <div class="md:col-span-12 mt-8">
            <div class="flex items-center space-x-2 mb-2">
                <span class="text-2xl">ğŸ“Š</span>
                <h3 class="text-2xl font-bold text-gray-800">å‘¨æŠ¥è¡¨ï¼šäº¤ä»˜æ•ˆç‡ä¸æˆæœ¬æ§åˆ¶</h3>
            </div>
            <p class="text-gray-600 mb-6">
                <strong>æ ¸å¿ƒåœºæ™¯ï¼š</strong> å‘¨ä¸€ç»è¥ä¾‹ä¼šã€‚ç»“åˆ ERP ä¸ MESï¼Œå¹³è¡¡äº§èƒ½è´Ÿè·ä¸å®¢æˆ·äº¤æœŸã€‚
            </p>
        </div>

        <!-- Chart 3: Plan vs Actual -->
        <div class="md:col-span-6 bg-white rounded-xl shadow-md p-6 relative">
            <div class="flex justify-between items-start border-b pb-2 mb-4">
                <h4 class="text-lg font-semibold text-gray-700">äº§çº¿è®¡åˆ’è¾¾æˆç‡ (ERP vs MES)</h4>
                <button onclick="analyzeChart('plan')" class="text-xs bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-2 py-1 rounded transition flex items-center">
                    âœ¨ AI åå·®åˆ†æ
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-4">
                å¯¹æ¯”å„äº§çº¿çš„ä¸€å‘¨æ’äº§è®¡åˆ’ä¸å®é™…å…¥åº“é‡ã€‚
            </p>
            <div class="chart-container">
                <canvas id="weeklyPlanChart"></canvas>
            </div>
             <!-- AI Output Area -->
             <div id="ai-plan-result" class="ai-result-box"></div>
        </div>

        <!-- Chart 4: Inventory Efficiency -->
        <div class="md:col-span-6 bg-white rounded-xl shadow-md p-6 relative">
            <div class="flex justify-between items-start border-b pb-2 mb-4">
                <h4 class="text-lg font-semibold text-gray-700">å…³é”®ç‰©æ–™å‘¨è½¬è¶‹åŠ¿ (WMS)</h4>
                <button onclick="analyzeChart('stock')" class="text-xs bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-2 py-1 rounded transition flex items-center">
                    âœ¨ AI ä¼˜åŒ–å»ºè®®
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-4">
                ç›‘æ§é«˜ä»·å€¼ç”µå­å…ƒå™¨ä»¶çš„åº“å­˜å‘¨è½¬å¤©æ•°ã€‚
            </p>
            <div class="chart-container">
                <canvas id="weeklyStockChart"></canvas>
            </div>
            <!-- AI Output Area -->
            <div id="ai-stock-result" class="ai-result-box"></div>
        </div>

        <!-- SECTION 3: MONTHLY STRATEGIC REPORT (Finance & Risk) -->
        <div class="md:col-span-12 mt-8">
            <div class="flex items-center space-x-2 mb-2">
                <span class="text-2xl">ğŸ›¡ï¸</span>
                <h3 class="text-2xl font-bold text-gray-800">æœˆæŠ¥è¡¨ï¼šç»è¥å¥åº·åº¦ä¸é£é™©é£æ§</h3>
            </div>
            <p class="text-gray-600 mb-6">
                <strong>æ ¸å¿ƒåœºæ™¯ï¼š</strong> æœˆåº¦æ€»ç»åŠæ±‡æŠ¥ã€‚æ•´åˆè´¢åŠ¡ç°é‡‘æµä¸å…¨åŸŸä¸šåŠ¡æ•°æ®ï¼Œè¯„ä¼°ä¼ä¸šéŸ§æ€§ã€‚
            </p>
        </div>

        <!-- Chart 5: Cost Breakdown -->
        <div class="md:col-span-5 bg-white rounded-xl shadow-md p-6 relative">
            <div class="flex justify-between items-start border-b pb-2 mb-4">
                <h4 class="text-lg font-semibold text-gray-700">ç”Ÿäº§æˆæœ¬æ„æˆåˆ†æ (Finance)</h4>
                <button onclick="analyzeChart('cost')" class="text-xs bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-2 py-1 rounded transition flex items-center">
                    âœ¨ AI é™æœ¬å»ºè®®
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-4">
                æœ¬æœˆæ€»æˆæœ¬æ‹†è§£ä¸å¼‚å¸¸è¯†åˆ«ã€‚
            </p>
            <div class="chart-container">
                <canvas id="monthlyCostChart"></canvas>
            </div>
            <!-- AI Output Area -->
            <div id="ai-cost-result" class="ai-result-box"></div>
        </div>

        <!-- Chart 6: Enterprise Risk Radar -->
        <div class="md:col-span-7 bg-white rounded-xl shadow-md p-6 relative">
            <div class="flex justify-between items-start border-b pb-2 mb-4">
                <h4 class="text-lg font-semibold text-gray-700">ä¼ä¸šç»è¥é£é™©é›·è¾¾ (AI Risk Control)</h4>
                <button onclick="analyzeChart('risk')" class="text-xs bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-2 py-1 rounded transition flex items-center">
                    âœ¨ AI é£é™©è¯„ä¼°
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-4">
                å¤šç»´é£é™©è¯„åˆ† (0-100ï¼Œè¶Šé«˜è¶Šå®‰å…¨)ã€‚
            </p>
            <div class="chart-container">
                <canvas id="monthlyRiskChart"></canvas>
            </div>
            <!-- AI Output Area -->
            <div id="ai-risk-result" class="ai-result-box"></div>
        </div>

        <!-- SECTION 4: DATA WORKFLOW VISUALIZATION -->
        <div class="md:col-span-12 mt-12 mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">ç³»ç»Ÿæ¶æ„ï¼šæ•°æ®æµä¸ä¸šåŠ¡æµèåˆ</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-7 gap-4 items-center">
                <!-- Sources -->
                <div class="md:col-span-2 flex flex-col gap-4">
                    <div class="flow-box border-l-blue-500">
                        <div class="text-sm text-gray-400">èµ„é‡‘æµ</div>
                        è´¢åŠ¡ç³»ç»Ÿ / ERP
                    </div>
                    <div class="flow-box border-l-blue-500">
                        <div class="text-sm text-gray-400">æ•°æ®æµ</div>
                        MES / IoT / PLC
                    </div>
                    <div class="flow-box border-l-blue-500">
                        <div class="text-sm text-gray-400">ç‰©æµ</div>
                        WMS / ä¾›åº”é“¾
                    </div>
                </div>

                <!-- Arrow -->
                <div class="md:col-span-1 flow-arrow hidden md:flex">
                    â¤
                </div>

                <!-- AI Processing -->
                <div class="md:col-span-1 flow-box bg-indigo-50 border-none ring-2 ring-indigo-500 py-12">
                    <div class="text-3xl mb-2">ğŸ§ </div>
                    <div class="font-bold text-indigo-700">Gemini<br>AI å¼•æ“</div>
                    <div class="text-xs text-indigo-500 mt-2">LLM æ¨ç† &<br>TTS è¯­éŸ³</div>
                </div>

                <!-- Arrow -->
                <div class="md:col-span-1 flow-arrow hidden md:flex">
                    â¤
                </div>

                <!-- Output -->
                <div class="md:col-span-2 flex flex-col gap-4">
                    <div class="flow-box border-l-emerald-500">
                        <div class="text-sm text-gray-400">ç®¡ç†å±‚</div>
                        <strong>AI ç»è¥é©¾é©¶èˆ±</strong>
                        <div class="text-xs">æœˆåº¦æˆ˜ç•¥å†³ç­–</div>
                    </div>
                    <div class="flow-box border-l-amber-500">
                        <div class="text-sm text-gray-400">æ‰§è¡Œå±‚</div>
                        <strong>AI è¯­éŸ³ç®€æŠ¥</strong>
                        <div class="text-xs">å®æ—¶å¼‚å¸¸é¢„è­¦</div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-gray-800 text-gray-400 py-6 text-center">
        <p>&copy; 2024 å·¥ä¸šæ™ºèƒ½è§£å†³æ–¹æ¡ˆ | Powered by Gemini API</p>
    </footer>

    <!-- Chat Widget Toggle Button -->
    <div id="chat-toggle" class="chat-toggle-btn" onclick="toggleChat()">
        ğŸ’¬
    </div>

    <!-- Chat Widget Window -->
    <div id="chat-widget" class="chat-widget">
        <div class="chat-header">
            <span>ğŸ¤– æ™ºèƒ½å·¥å‚åŠ©æ‰‹</span>
            <span onclick="toggleChat()" class="cursor-pointer text-xl">Ã—</span>
        </div>
        <div id="chat-messages" class="chat-body">
            <div class="chat-message ai">
                æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ AI æ•°æ®åŠ©æ‰‹ã€‚åŸºäºå½“å‰çš„ç”Ÿäº§å’Œè´¢åŠ¡æ•°æ®ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ
            </div>
        </div>
        <div class="chat-footer">
            <input type="text" id="chat-input" placeholder="ä¾‹å¦‚ï¼šæœ¬å‘¨åº“å­˜å‘¨è½¬å¦‚ä½•ï¼Ÿ" 
                   class="flex-1 border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   onkeypress="if(event.key === 'Enter') sendChatMessage()">
            <button onclick="sendChatMessage()" class="bg-indigo-600 text-white rounded px-4 py-2 hover:bg-indigo-700">â¤</button>
        </div>
    </div>

    <!-- Email Report Modal -->
    <div id="email-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">ğŸ“§ å‘¨æŠ¥é‚®ä»¶ç”Ÿæˆ (Draft)</h3>
                <button onclick="closeEmailModal()" class="text-gray-500 hover:text-gray-800 text-2xl">Ã—</button>
            </div>
            <div id="email-body" class="bg-gray-50 p-4 rounded border border-gray-200 text-sm font-mono text-gray-700 whitespace-pre-wrap max-h-96 overflow-y-auto">
                <div class="loader"></div> æ­£åœ¨ç”Ÿæˆä¸“ä¸šé‚®ä»¶è‰ç¨¿...
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="closeEmailModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">
                    å–æ¶ˆ
                </button>
                <button onclick="copyEmail()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
                    å¤åˆ¶å†…å®¹
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- GEMINI API CONFIGURATION ---
        const apiKey = ""; // Runtime Environment will provide this
        
        // Data Store for Context (Simulating a real data store)
        const dashboardData = {
            equipment: {
                labels: ['æ­£å¸¸è¿è¡Œ', 'æ•…éšœåœæœº', 'å¾…æ–™/æ¢æ¨¡', 'è®¡åˆ’ç»´æŠ¤'],
                data: [65, 12, 15, 8],
                context: "è®¾å¤‡ç¨¼åŠ¨ç‡æ•°æ®ã€‚æ•…éšœç‡12%åé«˜ï¼Œä¸»è¦é›†ä¸­åœ¨2å·äº§çº¿ã€‚"
            },
            defect: {
                labels: ['è¡¨é¢å–·æ¶‚ä¸å‡åŒ€', 'å°ºå¯¸å…¬å·®è¶…æ ‡', 'ç”µå­å…ƒä»¶ç„Šæ¥ä¸è‰¯', 'åŒ…è£…ç‰©æ–™ç ´æŸ', 'è£…é…é—´éš™è¿‡å¤§'],
                data: [42, 28, 15, 12, 8],
                context: "ä¸è‰¯å“å½’å› æ•°æ®ã€‚è¡¨é¢å–·æ¶‚é—®é¢˜å æ¯”æœ€é«˜ï¼Œå»ºè®®æ£€æŸ¥å–·å˜´å‹åŠ›ã€‚"
            },
            plan: {
                labels: ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'],
                dataPlan: [1200, 1250, 1300, 1300, 1250, 1000, 800],
                dataActual: [1180, 1100, 1290, 1310, 1240, 950, 810],
                context: "è®¡åˆ’ vs å®é™…äº§å‡ºã€‚å‘¨äºŒã€å‘¨å…­åå·®è¾ƒå¤§ï¼Œå¯èƒ½å­˜åœ¨ç‰©æ–™ä¾›åº”é—®é¢˜ã€‚"
            },
            stock: {
                labels: ['ç¬¬1å‘¨', 'ç¬¬2å‘¨', 'ç¬¬3å‘¨', 'ç¬¬4å‘¨', 'ç¬¬5å‘¨', 'ç¬¬6å‘¨'],
                data: [22, 21.5, 20, 18.5, 18, 17.2],
                context: "åº“å­˜å‘¨è½¬å¤©æ•°è¶‹åŠ¿ã€‚å‘ˆç°ä¸‹é™è¶‹åŠ¿ï¼Œç‰©æµæ•ˆç‡æå‡ï¼Œèµ„é‡‘å ç”¨å‡å°‘ã€‚"
            },
            cost: {
                labels: ['ç›´æ¥ææ–™', 'ç›´æ¥äººå·¥', 'åˆ¶é€ è´¹ç”¨', 'èƒ½æºæ¶ˆè€—', 'ç‰©æµè¿è¾“'],
                data: [55, 20, 12, 8, 5],
                context: "æˆæœ¬æ„æˆã€‚èƒ½æºæ¶ˆè€—å æ¯”8%ï¼Œè¾ƒä¸Šæœˆä¸Šå‡2.5%ï¼Œå¯èƒ½æœ‰è®¾å¤‡ç©ºè½¬ã€‚"
            },
            risk: {
                labels: ['ç°é‡‘æµå¥åº·åº¦', 'ä¾›åº”é“¾ç¨³å®šæ€§', 'ç”Ÿäº§å®‰å…¨åˆè§„', 'è®¢å•äº¤ä»˜èƒ½åŠ›', 'åº“å­˜è‰¯æ€§ç‡', 'è®¾å¤‡å¥åº·åº¦'],
                data: [85, 65, 92, 78, 88, 70],
                context: "ä¼ä¸šé£é™©é›·è¾¾ã€‚ä¾›åº”é“¾ç¨³å®šæ€§å¾—åˆ†65ï¼ˆåä½ï¼‰ï¼Œå­˜åœ¨å•ä¸€ä¾›åº”å•†é£é™©ã€‚"
            }
        };

        // --- GEMINI API FUNCTIONS ---

        async function callGemini(promptText) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }]
                    })
                });
                
                if (!response.ok) throw new Error('API Request Failed');
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "AI æœåŠ¡è¿æ¥ç¹å¿™ï¼Œè¯·ç¨åå†è¯•ã€‚";
            }
        }

        async function speakText(text) {
            try {
                // Simplified text for speech to save bandwidth/latency
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: {
                                        voiceName: "Kore" // Using a clear voice
                                    }
                                }
                            }
                        }
                    })
                });

                if (!response.ok) throw new Error('TTS Request Failed');
                
                const data = await response.json();
                const audioContent = data.candidates[0].content.parts[0].inlineData.data;
                
                // Decode Base64 and play
                const audioBytes = Uint8Array.from(atob(audioContent), c => c.charCodeAt(0));
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                // 24kHz sample rate is typical for Gemini TTS
                const sampleRate = 24000; 
                
                // Convert 16-bit PCM to Float32
                const pcm16 = new Int16Array(audioBytes.buffer);
                const float32 = new Float32Array(pcm16.length);
                for (let i = 0; i < pcm16.length; i++) {
                    float32[i] = pcm16[i] / 32768;
                }
                
                const buffer = audioContext.createBuffer(1, float32.length, sampleRate);
                buffer.getChannelData(0).set(float32);
                
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start();
                
            } catch (error) {
                console.error("TTS Error:", error);
                alert("è¯­éŸ³æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘è®¾ç½®ã€‚");
            }
        }

        // --- FEATURE 1: CHART INSIGHTS ---
        
        async function analyzeChart(chartKey) {
            const resultBox = document.getElementById(`ai-${chartKey}-result`);
            const dataContext = dashboardData[chartKey];
            
            // UI Loading State
            resultBox.style.display = 'block';
            resultBox.innerHTML = '<div class="loader"></div> æ­£åœ¨è¿›è¡Œ AI æ ¹å› åˆ†æ...';
            
            const prompt = `
                ä½ æ˜¯ä¸€ä½å·¥ä¸šæ•°æ®åˆ†æä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹åˆ¶é€ ä¼ä¸šçš„å›¾è¡¨æ•°æ®è¿›è¡Œåˆ†æã€‚
                
                æ•°æ®èƒŒæ™¯: ${dataContext.context}
                æ•°æ®æ ‡ç­¾: ${dataContext.labels.join(', ')}
                æ•°æ®æ•°å€¼: ${JSON.stringify(dataContext.data || dataContext.dataActual)}
                
                ä»»åŠ¡ï¼š
                1. ç”¨ç®€ç»ƒçš„ä¸­æ–‡æŒ‡å‡ºç°çŠ¶ (Insight)ã€‚
                2. ç»™å‡º 2 æ¡å…·ä½“çš„æ”¹å–„å»ºè®® (Actions)ã€‚
                è¯·ä½¿ç”¨HTMLæ ¼å¼ï¼Œç”¨ <strong> åŠ ç²—å…³é”®ç‚¹ã€‚
            `;

            const insight = await callGemini(prompt);
            
            // Render Result
            resultBox.innerHTML = `<strong>âœ¨ AI æ™ºèƒ½è¯Šæ–­ï¼š</strong><br>${insight}`;
        }

        // --- FEATURE 2: EXECUTIVE BRIEFING ---

        let currentBriefingText = ""; // Store for TTS

        async function generateBriefing() {
            const loader = document.getElementById('briefing-loader');
            const content = document.getElementById('briefing-content');
            const btnSpeak = document.getElementById('btn-speak');
            
            loader.classList.remove('hidden');
            content.classList.add('hidden');
            btnSpeak.classList.add('hidden');
            
            // Aggregate Context
            const fullContext = Object.values(dashboardData).map(d => d.context).join("; ");
            
            const prompt = `
                ä½ æ˜¯ä¸€ä½å·¥å‚æ€»ç»ç†åŠ©ç†ã€‚åŸºäºä»¥ä¸‹å…¨å‚å…³é”®æŒ‡æ ‡æ¦‚è§ˆï¼Œè¯·æ’°å†™ä¸€ä»½ç®€çŸ­çš„æ™¨ä¼šæ±‡æŠ¥æ‘˜è¦ã€‚
                
                æ•°æ®æ¦‚è§ˆ: ${fullContext}
                
                è¦æ±‚ï¼š
                1. è¯­æ°”ä¸“ä¸šã€è‡ªä¿¡ã€ç®€æ´ã€‚
                2. åŒ…å«â€œæ˜¨æ—¥å›é¡¾â€ã€â€œé£é™©é¢„è­¦â€å’Œâ€œä»Šæ—¥é‡ç‚¹â€ä¸‰ä¸ªéƒ¨åˆ†ã€‚
                3. æ€»å­—æ•°æ§åˆ¶åœ¨ 150 å­—ä»¥å†…ã€‚
                4. è¾“å‡ºçº¯æ–‡æœ¬ï¼Œä¸è¦Markdownæ ¼å¼ã€‚
            `;

            const text = await callGemini(prompt);
            currentBriefingText = text;
            
            loader.classList.add('hidden');
            content.classList.remove('hidden');
            content.innerText = text;
            btnSpeak.classList.remove('hidden');
        }

        function speakBriefing() {
            if(currentBriefingText) {
                speakText(currentBriefingText);
            }
        }

        // --- FEATURE 3: CHATBOT WIDGET ---
        
        function toggleChat() {
            const widget = document.getElementById('chat-widget');
            const btn = document.getElementById('chat-toggle');
            widget.classList.toggle('open');
            btn.style.display = widget.classList.contains('open') ? 'none' : 'flex';
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const messages = document.getElementById('chat-messages');
            const userText = input.value.trim();
            if (!userText) return;

            // Add User Message
            messages.innerHTML += `<div class="chat-message user">${userText}</div>`;
            input.value = '';
            messages.scrollTop = messages.scrollHeight;

            // Prepare Context
            const fullContext = Object.values(dashboardData).map(d => d.context).join("; ");
            
            const prompt = `
                ä½ æ˜¯ä¸€ä¸ªå·¥å‚ä»ªè¡¨ç›˜çš„æ™ºèƒ½åŠ©æ‰‹ã€‚ä»¥ä¸‹æ˜¯å½“å‰çš„ç”Ÿäº§æ•°æ®æ‘˜è¦ï¼š
                ${fullContext}
                
                ç”¨æˆ·æé—®ï¼š${userText}
                
                è¯·ç”¨ç®€çŸ­çš„ä¸­æ–‡å›ç­”ï¼ˆ50å­—ä»¥å†…ï¼‰ï¼ŒåŸºäºæ•°æ®ç»™å‡ºäº‹å®ã€‚
            `;

            // Call API
            const loadingId = Date.now();
            messages.innerHTML += `<div id="${loadingId}" class="chat-message ai"><div class="loader"></div></div>`;
            messages.scrollTop = messages.scrollHeight;

            const answer = await callGemini(prompt);
            
            // Replace Loading with Answer
            const loadingDiv = document.getElementById(loadingId);
            loadingDiv.innerText = answer;
            messages.scrollTop = messages.scrollHeight;
        }

        // --- FEATURE 4: EMAIL REPORT GENERATOR ---

        function closeEmailModal() {
            document.getElementById('email-modal').classList.remove('open');
        }

        function copyEmail() {
            const text = document.getElementById('email-body').innerText;
            navigator.clipboard.writeText(text);
            alert('é‚®ä»¶å†…å®¹å·²å¤åˆ¶ï¼');
        }

        async function generateEmailReport() {
            const modal = document.getElementById('email-modal');
            const body = document.getElementById('email-body');
            modal.classList.add('open');
            body.innerHTML = '<div class="loader"></div> æ­£åœ¨ç”Ÿæˆä¸“ä¸šé‚®ä»¶è‰ç¨¿...';

            const fullContext = Object.values(dashboardData).map(d => d.context).join("; ");
            const prompt = `
                ä½ æ˜¯ä¸€ä½è¿è¥æ€»ç›‘ã€‚åŸºäºä»¥ä¸‹æ•°æ®ï¼Œèµ·è‰ä¸€ä»½å‘é€ç»™â€œé›†å›¢ç®¡ç†å±‚â€çš„æœ¬å‘¨è¿è¥å‘¨æŠ¥é‚®ä»¶ã€‚
                
                æ•°æ®æ¦‚è§ˆ: ${fullContext}
                
                æ ¼å¼è¦æ±‚ï¼š
                ä¸»é¢˜ï¼š[å‘¨æŠ¥] é•¿ä¸‰è§’å·¥å‚è¿è¥ç®€æŠ¥ - YYYY/MM/DD
                æ”¶ä»¶äººï¼šé›†å›¢ç®¡ç†å±‚
                æ­£æ–‡ç»“æ„ï¼š
                1. å…³é”®æŒ‡æ ‡æ¦‚è§ˆ (Bullet points)
                2. æœ¬å‘¨ä¸»è¦é£é™© (Risk)
                3. ä¸‹å‘¨æ”¹è¿›è®¡åˆ’ (Action Plan)
                
                è¯­æ°”ï¼šæ­£å¼ã€å®¢è§‚ã€æ•°æ®é©±åŠ¨ã€‚
                è¾“å‡ºçº¯æ–‡æœ¬æ ¼å¼ã€‚
            `;

            const text = await callGemini(prompt);
            body.innerText = text;
        }

        // --- EXISTING CHART CONFIGURATIONS (UNCHANGED LOGIC, JUST RE-INIT) ---
        // --- UTILITY: LABEL WRAPPING FOR CHART.JS ---
        function splitLabel(label, maxLength = 16) {
            if (label.length <= maxLength) return label;
            const limit = 10; 
            const result = [];
            for (let i = 0; i < label.length; i += limit) {
                result.push(label.substring(i, i + limit));
            }
            return result;
        }

        const commonTooltipConfig = {
            callbacks: {
                title: function(tooltipItems) {
                    const item = tooltipItems[0];
                    let label = item.chart.data.labels[item.dataIndex];
                    if (Array.isArray(label)) return label.join('');
                    else return label;
                }
            }
        };

        const colors = {
            primary: '#4F46E5', secondary: '#06B6D4', accent: '#F59E0B',
            danger: '#EF4444', success: '#10B981', bg: 'rgba(79, 70, 229, 0.2)'
        };

        // Initialize Charts
        window.onload = function() {
            // Chart 1
            new Chart(document.getElementById('dailyEquipmentChart'), {
                type: 'doughnut',
                data: {
                    labels: dashboardData.equipment.labels,
                    datasets: [{ data: dashboardData.equipment.data, backgroundColor: [colors.success, colors.danger, colors.accent, '#9CA3AF'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, tooltip: commonTooltipConfig } }
            });

            // Chart 2
            const defectLabels = dashboardData.defect.labels.map(l => splitLabel(l));
            new Chart(document.getElementById('dailyDefectChart'), {
                type: 'bar',
                data: {
                    labels: defectLabels,
                    datasets: [{ label: 'ç¼ºé™·æ•°é‡ (ä»¶)', data: dashboardData.defect.data, backgroundColor: colors.primary, borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: commonTooltipConfig, legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });

            // Chart 3
            new Chart(document.getElementById('weeklyPlanChart'), {
                type: 'bar',
                data: {
                    labels: dashboardData.plan.labels,
                    datasets: [
                        { label: 'è®¡åˆ’äº§é‡', data: dashboardData.plan.dataPlan, backgroundColor: '#E5E7EB' },
                        { label: 'å®é™…äº§å‡º', data: dashboardData.plan.dataActual, backgroundColor: colors.secondary }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: commonTooltipConfig }, scales: { y: { beginAtZero: true } } }
            });

            // Chart 4
            new Chart(document.getElementById('weeklyStockChart'), {
                type: 'line',
                data: {
                    labels: dashboardData.stock.labels,
                    datasets: [{ label: 'å‘¨è½¬å¤©æ•°', data: dashboardData.stock.data, borderColor: colors.accent, backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: commonTooltipConfig }, scales: { y: { min: 10 } } }
            });

            // Chart 5
            new Chart(document.getElementById('monthlyCostChart'), {
                type: 'pie',
                data: {
                    labels: dashboardData.cost.labels,
                    datasets: [{ data: dashboardData.cost.data, backgroundColor: [colors.primary, colors.secondary, '#6366F1', colors.accent, '#EC4899'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: commonTooltipConfig } }
            });

            // Chart 6
            new Chart(document.getElementById('monthlyRiskChart'), {
                type: 'radar',
                data: {
                    labels: dashboardData.risk.labels,
                    datasets: [
                        { label: 'æœ¬æœˆè¯„åˆ†', data: dashboardData.risk.data, fill: true, backgroundColor: colors.bg, borderColor: colors.primary, pointBackgroundColor: colors.primary },
                        { label: 'è¡Œä¸šåŸºå‡†', data: [75, 75, 80, 80, 75, 75], fill: true, backgroundColor: 'rgba(156, 163, 175, 0.2)', borderColor: '#9CA3AF', borderDash: [5, 5] }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { angleLines: { display: true }, suggestedMin: 50, suggestedMax: 100 } }, plugins: { tooltip: commonTooltipConfig } }
            });
        };
    </script>
</body>
</html>